<div class="post">
		<h1 class="postTitle">
			<a id="cb_post_title_url" class="postTitle2" href="https://www.cnblogs.com/kevingrace/p/5892169.html">Haproxy+Keepalived高可用环境部署梳理（主主和主从模式）</a>
		</h1>
		<div class="clear"></div>
		<div class="postBody">
			<div id="cnblogs_post_body" class="blogpost-body __reader_view_article_wrap_7526896168481498__"><p>&nbsp;</p>
<p>Nginx、LVS、HAProxy 是目前使用最广泛的三种负载均衡软件，本人都在多个项目中实施过，通常会结合Keepalive做健康检查，实现故障转移的高可用功能。</p>
<div class="cnblogs_Highlighter sh-gutter">
<div><div id="highlighter_158349" class="syntaxhighlighter  bash"><div class="toolbar"><span><a href="#" class="toolbar_item command_help help">?</a></span></div><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div><div class="line number3 index2 alt2">3</div><div class="line number4 index3 alt1">4</div><div class="line number5 index4 alt2">5</div><div class="line number6 index5 alt1">6</div><div class="line number7 index6 alt2">7</div><div class="line number8 index7 alt1">8</div><div class="line number9 index8 alt2">9</div><div class="line number10 index9 alt1">10</div><div class="line number11 index10 alt2">11</div><div class="line number12 index11 alt1">12</div><div class="line number13 index12 alt2">13</div><div class="line number14 index13 alt1">14</div><div class="line number15 index14 alt2">15</div><div class="line number16 index15 alt1">16</div><div class="line number17 index16 alt2">17</div><div class="line number18 index17 alt1">18</div><div class="line number19 index18 alt2">19</div><div class="line number20 index19 alt1">20</div><div class="line number21 index20 alt2">21</div><div class="line number22 index21 alt1">22</div><div class="line number23 index22 alt2">23</div><div class="line number24 index23 alt1">24</div><div class="line number25 index24 alt2">25</div><div class="line number26 index25 alt1">26</div><div class="line number27 index26 alt2">27</div><div class="line number28 index27 alt1">28</div><div class="line number29 index28 alt2">29</div><div class="line number30 index29 alt1">30</div><div class="line number31 index30 alt2">31</div><div class="line number32 index31 alt1">32</div><div class="line number33 index32 alt2">33</div><div class="line number34 index33 alt1">34</div><div class="line number35 index34 alt2">35</div><div class="line number36 index35 alt1">36</div><div class="line number37 index36 alt2">37</div><div class="line number38 index37 alt1">38</div><div class="line number39 index38 alt2">39</div><div class="line number40 index39 alt1">40</div><div class="line number41 index40 alt2">41</div><div class="line number42 index41 alt1">42</div><div class="line number43 index42 alt2">43</div><div class="line number44 index43 alt1">44</div><div class="line number45 index44 alt2">45</div><div class="line number46 index45 alt1">46</div><div class="line number47 index46 alt2">47</div><div class="line number48 index47 alt1">48</div><div class="line number49 index48 alt2">49</div><div class="line number50 index49 alt1">50</div><div class="line number51 index50 alt2">51</div><div class="line number52 index51 alt1">52</div><div class="line number53 index52 alt2">53</div><div class="line number54 index53 alt1">54</div><div class="line number55 index54 alt2">55</div><div class="line number56 index55 alt1">56</div><div class="line number57 index56 alt2">57</div><div class="line number58 index57 alt1">58</div><div class="line number59 index58 alt2">59</div><div class="line number60 index59 alt1">60</div><div class="line number61 index60 alt2">61</div><div class="line number62 index61 alt1">62</div><div class="line number63 index62 alt2">63</div><div class="line number64 index63 alt1">64</div><div class="line number65 index64 alt2">65</div><div class="line number66 index65 alt1">66</div><div class="line number67 index66 alt2">67</div><div class="line number68 index67 alt1">68</div><div class="line number69 index68 alt2">69</div><div class="line number70 index69 alt1">70</div><div class="line number71 index70 alt2">71</div><div class="line number72 index71 alt1">72</div><div class="line number73 index72 alt2">73</div><div class="line number74 index73 alt1">74</div><div class="line number75 index74 alt2">75</div><div class="line number76 index75 alt1">76</div><div class="line number77 index76 alt2">77</div><div class="line number78 index77 alt1">78</div><div class="line number79 index78 alt2">79</div><div class="line number80 index79 alt1">80</div><div class="line number81 index80 alt2">81</div><div class="line number82 index81 alt1">82</div><div class="line number83 index82 alt2">83</div><div class="line number84 index83 alt1">84</div><div class="line number85 index84 alt2">85</div><div class="line number86 index85 alt1">86</div><div class="line number87 index86 alt2">87</div><div class="line number88 index87 alt1">88</div><div class="line number89 index88 alt2">89</div><div class="line number90 index89 alt1">90</div><div class="line number91 index90 alt2">91</div><div class="line number92 index91 alt1">92</div><div class="line number93 index92 alt2">93</div><div class="line number94 index93 alt1">94</div><div class="line number95 index94 alt2">95</div><div class="line number96 index95 alt1">96</div><div class="line number97 index96 alt2">97</div><div class="line number98 index97 alt1">98</div><div class="line number99 index98 alt2">99</div><div class="line number100 index99 alt1">100</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="bash plain">1）在四层（tcp）实现负载均衡的软件：</code></div><div class="line number2 index1 alt1"><code class="bash plain">lvs------&gt;重量级</code></div><div class="line number3 index2 alt2"><code class="bash plain">nginx------&gt;轻量级，带缓存功能，正则表达式较灵活</code></div><div class="line number4 index3 alt1"><code class="bash plain">haproxy------&gt;模拟四层转发，较灵活</code></div><div class="line number5 index4 alt2"><code class="bash spaces">&nbsp;</code>&nbsp;</div><div class="line number6 index5 alt1"><code class="bash plain">2）在七层（http）实现反向代理的软件：</code></div><div class="line number7 index6 alt2"><code class="bash plain">haproxy------&gt;天生技能，全面支持七层代理，会话保持，标记，路径转移；</code></div><div class="line number8 index7 alt1"><code class="bash plain">nginx------&gt;只在http协议和mail协议上功能比较好，性能与haproxy差不多；</code></div><div class="line number9 index8 alt2"><code class="bash plain">apache------&gt;功能较差&lt;br&gt;</code></div><div class="line number10 index9 alt1">&nbsp;</div><div class="line number11 index10 alt2"><code class="bash plain">总的来说，一般是lvs做4层负载；nginx做7层负载；haproxy比较灵活，4层和7层负载均衡都能做</code></div><div class="line number12 index11 alt1">&nbsp;</div><div class="line number13 index12 alt2"><code class="bash plain">一般对负载均衡的使用是随着网站规模的提升根据不同的阶段来使用不同的技术。具体的应用需求还得具体分析：</code></div><div class="line number14 index13 alt1"><code class="bash plain">1）如果是中小型的 Web 应用，比如日PV小于1000 万，用 Nginx 就完全可以了；</code></div><div class="line number15 index14 alt2"><code class="bash plain">2）如果机器不少，可以用DNS轮询， LVS所耗费的机器还是比较多的；大型网站或重要的服务，且服务器比较多时， 可以考虑用LVS。</code></div><div class="line number16 index15 alt1">&nbsp;</div><div class="line number17 index16 alt2"><code class="bash plain">还有一种是通过硬件来进行进行，常见的硬件有比较昂贵的F5和Array等商用的负载均衡器，它的优点就是有专业的维护团队来对这些服务进行维护、缺点就是花销太大，所以对于规模较小</code></div><div class="line number18 index17 alt1"><code class="bash plain">的网络服务来说暂时还没有需要使用；另外一种就是类似于 Nginx</code><code class="bash plain">/LVS/HAProxy</code> <code class="bash plain">的基于 Linux 的开源免费的负载均衡软件，这些都是通过软件级别来实现，所以费用非常低廉。目前关于网</code></div><div class="line number19 index18 alt2"><code class="bash plain">站架构一般比较合理流行的架构方案： Web 前端采用Nginx</code><code class="bash plain">/HAProxy</code><code class="bash plain">+Keepalived 作负载均衡器；后端采用 MySQL 数据库一主多从和读写分离，采用 LVS+Keepalived 的架构。 当然要根据</code></div><div class="line number20 index19 alt1"><code class="bash plain">项目具体需求制定方案。下面说说各自的特点和适用场合。</code></div><div class="line number21 index20 alt2">&nbsp;</div><div class="line number22 index21 alt1"><code class="bash plain">------------------------------------------------------------------------------------------------------------------</code></div><div class="line number23 index22 alt2"><code class="bash plain">下面简单说下Nginx、LVS、HAProxy 负载均衡软件的优缺点：</code></div><div class="line number24 index23 alt1">&nbsp;</div><div class="line number25 index24 alt2"><code class="bash plain">一、Nginx的优点是：</code></div><div class="line number26 index25 alt1"><code class="bash plain">1）工作在网络的7层之上，可以针对 http 应用做一些分流的策略，比如针对域名、目录结构，它的正则规则比 HAProxy 更为强大和灵活，这也是它目前广泛流</code></div><div class="line number27 index26 alt2"><code class="bash plain">行的主要原因之一， Nginx 单凭这点可利用的场合就远多于 LVS 了。</code></div><div class="line number28 index27 alt1"><code class="bash plain">2） Nginx 对网络稳定性的依赖非常小，理论上能 </code><code class="bash functions">ping</code> <code class="bash plain">通就就能进行负载功能，这个也是它的优势之一；相反 LVS 对网络稳定性依赖比较大，这点本人深有体会；</code></div><div class="line number29 index28 alt2"><code class="bash plain">3） Nginx 安装和配置比较简单，测试起来比较方便，它基本能把错误用日志打印出来。 LVS 的配置、测试就要花比较长的时间了， LVS 对网络依赖比较大。</code></div><div class="line number30 index29 alt1"><code class="bash plain">4）可以承担高负载压力且稳定，在硬件不差的情况下一般能支撑几万次的并发量，负载度比 LVS 相对小些。</code></div><div class="line number31 index30 alt2"><code class="bash plain">5） Nginx 可以通过端口检测到服务器内部的故障，比如根据服务器处理网页返回的状态码、超时等等，并且会把返回错误的请求重新提交到另一个节点，不过其中缺点就是不支持url来检测。</code></div><div class="line number32 index31 alt1"><code class="bash plain">比如用户正在上传一个文件，而处理该上传的节点刚好在上传过程中出现故障， Nginx 会把上传切到另一台服务器重新处 理，而LVS就直接断掉了，如果是上传一个很大的文件或者很重要的文</code></div><div class="line number33 index32 alt2"><code class="bash plain">件的话，用户可能会因此而不满。</code></div><div class="line number34 index33 alt1"><code class="bash plain">6）Nginx 不仅仅是一款优秀的负载均衡器/反向代理软件，它同时也是功能强大的 Web 应用服务器。 LNMP 也是近几年非常流行的 web 架构，在高流量的环境中稳定性也很好。</code></div><div class="line number35 index34 alt2"><code class="bash plain">7）Nginx 现在作为 Web 反向加速缓存越来越成熟了，速度比传统的 Squid 服务器更快，可以考虑用其作为反向代理加速器。</code></div><div class="line number36 index35 alt1"><code class="bash plain">8）Nginx 可作为中层反向代理使用，这一层面 Nginx 基本上无对手，唯一可以对比 Nginx 的就只有 lighttpd 了，不过 lighttpd 目前还没有做到 Nginx 完全的功能，配置也不那么清晰易读，</code></div><div class="line number37 index36 alt2"><code class="bash plain">社区资料也远远没 Nginx 活跃。</code></div><div class="line number38 index37 alt1"><code class="bash plain">9） Nginx 也可作为静态网页和图片服务器，这方面的性能也无对手。还有 Nginx社区非常活跃，第三方模块也很多。</code></div><div class="line number39 index38 alt2">&nbsp;</div><div class="line number40 index39 alt1"><code class="bash plain">Nginx 的缺点是：</code></div><div class="line number41 index40 alt2"><code class="bash plain">1）Nginx 仅能支持 http、 https 和 Email 协议，这样就在适用范围上面小些，这个是它的缺点。</code></div><div class="line number42 index41 alt1"><code class="bash plain">2）对后端服务器的健康检查，只支持通过端口来检测，不支持通过 url 来检测。不支持 Session 的直接保持，但能通过 ip_hash 来解决。</code></div><div class="line number43 index42 alt2">&nbsp;</div><div class="line number44 index43 alt1"><code class="bash plain">二、LVS：使用 Linux 内核集群实现一个高性能、 高可用的负载均衡服务器，它具有很好的可伸缩性（ Scalability)、可靠性（ Reliability)和可管理性（Manageability)。</code></div><div class="line number45 index44 alt2"><code class="bash plain">LVS 的优点是：</code></div><div class="line number46 index45 alt1"><code class="bash plain">1）抗负载能力强、是工作在网络 4 层之上仅作分发之用， 没有流量的产生，这个特点也决定了它在负载均衡软件里的性能最强的，对内存和 cpu 资源消耗比较低。</code></div><div class="line number47 index46 alt2"><code class="bash plain">2）配置性比较低，这是一个缺点也是一个优点，因为没有可太多配置的东西，所以并不需要太多接触，大大减少了人为出错的几率。</code></div><div class="line number48 index47 alt1"><code class="bash plain">3）工作稳定，因为其本身抗负载能力很强，自身有完整的双机热备方案，如LVS+Keepalived，不过我们在项目实施中用得最多的还是 LVS</code><code class="bash plain">/DR</code><code class="bash plain">+Keepalived。</code></div><div class="line number49 index48 alt2"><code class="bash plain">4）无流量， LVS 只分发请求，而流量并不从它本身出去，这点保证了均衡器 IO的性能不会收到大流量的影响。</code></div><div class="line number50 index49 alt1"><code class="bash plain">5）应用范围比较广，因为 LVS 工作在 4 层，所以它几乎可以对所有应用做负载均衡，包括 http、数据库、在线聊天室等等。</code></div><div class="line number51 index50 alt2">&nbsp;</div><div class="line number52 index51 alt1"><code class="bash plain">LVS 的缺点是：</code></div><div class="line number53 index52 alt2"><code class="bash plain">1）软件本身不支持正则表达式处理，不能做动静分离；而现在许多网站在这方面都有较强的需求，这个是 Nginx</code><code class="bash plain">/HAProxy</code><code class="bash plain">+Keepalived 的优势所在。</code></div><div class="line number54 index53 alt1"><code class="bash plain">2）如果是网站应用比较庞大的话， LVS</code><code class="bash plain">/DR</code><code class="bash plain">+Keepalived 实施起来就比较复杂了，特别后面有 Windows Server 的机器的话，如果实施及配置还有维护过程就比较复杂了，相对而言，</code></div><div class="line number55 index54 alt2"><code class="bash plain">Nginx</code><code class="bash plain">/HAProxy</code><code class="bash plain">+Keepalived 就简单多了。</code></div><div class="line number56 index55 alt1">&nbsp;</div><div class="line number57 index56 alt2"><code class="bash plain">三、HAProxy 的特点是：</code></div><div class="line number58 index57 alt1"><code class="bash plain">1）HAProxy 也是支持虚拟主机的。</code></div><div class="line number59 index58 alt2"><code class="bash plain">2）HAProxy 的优点能够补充 Nginx 的一些缺点，比如支持 Session 的保持，Cookie的引导；同时支持通过获取指定的 url 来检测后端服务器的状态。</code></div><div class="line number60 index59 alt1"><code class="bash plain">3）HAProxy 跟 LVS 类似，本身就只是一款负载均衡软件；单纯从效率上来讲HAProxy 会比 Nginx 有更出色的负载均衡速度，在并发处理上也是优于 Nginx 的。</code></div><div class="line number61 index60 alt2"><code class="bash plain">4）HAProxy 支持 TCP 协议的负载均衡转发，可以对 MySQL 读进行负载均衡，对后端的 MySQL 节点进行检测和负载均衡，大家可以用 LVS+Keepalived 对 MySQL主从做负载均衡。</code></div><div class="line number62 index61 alt1"><code class="bash plain">5）HAProxy 负载均衡策略非常多， HAProxy 的负载均衡算法现在具体有如下8种：</code></div><div class="line number63 index62 alt2"><code class="bash plain">1&gt; roundrobin，表示简单的轮询，这个不多说，这个是负载均衡基本都具备的；</code></div><div class="line number64 index63 alt1"><code class="bash plain">2&gt; static-rr，表示根据权重，建议关注；</code></div><div class="line number65 index64 alt2"><code class="bash plain">3&gt; leastconn，表示最少连接者先处理，建议关注；</code></div><div class="line number66 index65 alt1"><code class="bash plain">4&gt; </code><code class="bash functions">source</code><code class="bash plain">，表示根据请求源 IP，这个跟 Nginx 的 IP_hash 机制类似，我们用其作为解决 session 问题的一种方法，建议关注；</code></div><div class="line number67 index66 alt2"><code class="bash plain">5&gt; ri，表示根据请求的 URI；</code></div><div class="line number68 index67 alt1"><code class="bash plain">6&gt; rl_param，表示根据请求的 URl 参数’balance url_param’ requires an URLparameter name；</code></div><div class="line number69 index68 alt2"><code class="bash plain">7&gt; hdr(name)，表示根据 HTTP 请求头来锁定每一次 HTTP 请求；</code></div><div class="line number70 index69 alt1"><code class="bash plain">8&gt; rdp-cookie(name)，表示根据据 cookie(name)来锁定并哈希每一次 TCP 请求。</code></div><div class="line number71 index70 alt2">&nbsp;</div><div class="line number72 index71 alt1"><code class="bash plain">四、Nginx和LVS 对比的总结：</code></div><div class="line number73 index72 alt2"><code class="bash plain">1）Nginx 工作在网络的 7 层，所以它可以针对 http 应用本身来做分流策略，比如针对域名、目录结构等，相比之下 LVS 并不具备这样的功能，所以 Nginx 单凭这点可利用的场合就远多于LVS了；</code></div><div class="line number74 index73 alt1"><code class="bash plain">但 Nginx 有用的这些功能使其可调整度要高于 LVS，所以经常要去触碰触碰，触碰多了，人为出问题的 几率也就会大。</code></div><div class="line number75 index74 alt2"><code class="bash plain">2）Nginx 对网络稳定性的依赖较小，理论上只要 </code><code class="bash functions">ping</code> <code class="bash plain">得通，网页访问正常， Nginx就能连得通，这是 Nginx 的一大优势！ Nginx 同时还能区 分内外网，如果是同时拥有内外网的节点，就相当于</code></div><div class="line number76 index75 alt1"><code class="bash plain">单机拥有了备份线路； LVS 就比较依赖于网络环境，目前来看服务器在同一网段内并且 LVS 使用 direct 方式分流，效果较能得到保证。另外注意， LVS 需要向托管商至少申请多一个 ip 来做 </code></div><div class="line number77 index76 alt2"><code class="bash plain">Visual IP，貌似是不能用本身的 IP 来做 VIP 的。要做好 LVS 管理员，确实得跟进学习很多有关网络通信方面的知识，就不再是一个 HTTP 那么简单了。</code></div><div class="line number78 index77 alt1"><code class="bash plain">3）Nginx 安装和配置比较简单，测试起来也很方便，因为它基本能把错误用日志打印出来。 LVS 的安装和配置、测试就要花比较长的时间了； LVS 对网络依赖比较大，很多时候不能配置成功都是</code></div><div class="line number79 index78 alt2"><code class="bash plain">因为网络问题而不是配置问题，出了问题要解决也相应的会麻烦得多。</code></div><div class="line number80 index79 alt1"><code class="bash plain">4）Nginx 也同样能承受很高负载且稳定，但负载度和稳定度差 LVS 还有几个等级：Nginx 处理所有流量所以受限于机器 IO 和配置；本身的 bug 也还是难以避免的。</code></div><div class="line number81 index80 alt2"><code class="bash plain">5）Nginx 可以检测到服务器内部的故障，比如根据服务器处理网页返回的状态码、超时等等，并且会把返回错误的请求重新提交到另一个节点。目前 LVS 中ldirectd 也能支持针对服务器内部的情况</code></div><div class="line number82 index81 alt1"><code class="bash plain">来监控，但 LVS 的原理使其不能重发请求。比如用户正在上传一个文件，而处理该上传的节点刚好在上传过程中 出现故障， Nginx 会把上传切到另一台服务器重新处理，而 LVS 就直接断掉了，如果</code></div><div class="line number83 index82 alt2"><code class="bash plain">是上传一个很大的文件或者很重要的文件的话，用户可能会因此而恼火。</code></div><div class="line number84 index83 alt1"><code class="bash plain">6）Nginx 对请求的异步处理可以帮助节点服务器减轻负载，假如使用 apache 直接对外服务，那么出现很多的窄带链接时 apache 服务器将会占用大 量内存而不能释放，使用多一个 Nginx 做 apache </code></div><div class="line number85 index84 alt2"><code class="bash plain">代理的话，这些窄带链接会被 Nginx 挡住，apache 上就不会堆积过多的请求，这样就减少了相 当多的资源占用。这点使用squid 也有相同的作用，即使 squid 本身配置为不缓存，对 apache 还是有</code></div><div class="line number86 index85 alt1"><code class="bash plain">很大帮助的。</code></div><div class="line number87 index86 alt2"><code class="bash plain">7）Nginx 能支持 http、 https 和 email（ email 的功能比较少用）， LVS 所支持的应用在这点上会比 Nginx 更多。在使用上，一般最 前端所采取的策略应是 LVS，也就是 DNS 的指向应为 LVS 均衡器， </code></div><div class="line number88 index87 alt1"><code class="bash plain">LVS 的优点令它非常适合做这个任务。重要的ip地址，最好交由 LVS 托管，比如数据 库的 ip、 webservice 服务器的 ip等等，这些 ip 地址随着时间推移，使用面会越来越大，如果更换 ip 则故障会接踵</code></div><div class="line number89 index88 alt2"><code class="bash plain">而至。所以将这些重要 ip 交给 LVS 托管是最为稳妥的，这样做的唯一缺点是需要的 VIP 数量会比较多。Nginx 可作为 LVS 节点机器使用，一是可以利用 Nginx的功能，二是可以利 用 Nginx 的性能。当然</code></div><div class="line number90 index89 alt1"><code class="bash plain">这一层面也可以直接使用 squid，squid 的功能方面就比 Nginx 弱不少了，性能上也有所逊色于 Nginx。Nginx 也可作为中层代理使用，这一层面 Nginx 基本上无对手，唯一可以撼动 Nginx 的就只有 lighttpd </code></div><div class="line number91 index90 alt2"><code class="bash plain">了，不过 lighttpd 目前还没有能做到 Nginx 完全的功能，配置也不那么清晰易读。另外，中层代理的 IP 也是重要的，所以中层代理也拥有一个VIP 和 LVS 是最完美的方案了。具体的应用还得 具体分析，如果</code></div><div class="line number92 index91 alt1"><code class="bash plain">是比较小的网站（日 PV 小于 1000 万），用 Nginx 就完全可以了，如果机器也不少，可以用DNS 轮询， LVS 所耗费的机器还是比较多 的；大型网站或者重要的服务，机器不发愁的时候，要多多考虑利用 LVS。</code></div><div class="line number93 index92 alt2">&nbsp;</div><div class="line number94 index93 alt1">&nbsp;</div><div class="line number95 index94 alt2"><code class="bash plain">现在对网络负载均衡的使用是随着网站规模的提升根据不同的阶段来使用不同的技术：</code></div><div class="line number96 index95 alt1"><code class="bash plain">1）第一阶段：利用 Nginx 或 HAProxy 进行单点的负载均衡，这一阶段服务器规模刚脱离开单服务器、单数据库的模式，需要一定的负载均衡，但是仍 然规模较小没有专业的维护团队来进行维护，也没有需要进行大规模的网站部署。这样利用Nginx 或 HAproxy 就是第一选择，此时这些东西上手快， 配置容易，在七层之上利用 HTTP 协议就可以。这时是第一选择。</code></div><div class="line number97 index96 alt2"><code class="bash plain">2）第二阶段：随着网络服务进一步扩大，这时单点的 Nginx 已经不能满足，这时使用 LVS 或者商用 Array 就是首要选择， Nginx 此时就作为 LVS 或者 Array 的节点来使用，具体 LVS 或 Array 的是选择是根据</code></div><div class="line number98 index97 alt1"><code class="bash plain">公司规模和预算来选择，Array 的应用交付功能非常强大，本人在某项目中使用过，性价比也远高于 F5，商用首选！但是一般来说这阶段相关人才跟不上业务的提升，所以购买商业负载均衡已经成为了必经之路。</code></div><div class="line number99 index98 alt2"><code class="bash plain">3）第三阶段：这时网络服务已经成为主流产品，此时随着公司知名度也进一步扩展，相关人才的能力以及数量也随之提升，这时无论从开发适合自身产品的定制，以及降低成本来讲开源的 LVS，已经成为首选，这时 </code></div><div class="line number100 index99 alt1"><code class="bash plain">LVS 会成为主流。最终形成比较理想的基本架构为： Array</code><code class="bash plain">/LVS</code> <code class="bash plain">— Nginx</code><code class="bash plain">/Haproxy</code> <code class="bash plain">—Squid</code><code class="bash plain">/Varnish</code> <code class="bash plain">— AppServer。</code></div></div></td></tr></tbody></table></div></div>
</div>
<p><strong><span style="background-color: #ffff99;">软件负载均衡一般通过两种方式来实现：</span></strong>基于操作系统的软负载实现和基于第三方应用的软负载实现。LVS就是基于Linux操作系统实现的一种软负载，HAProxy就是开源的并且基于第三应用实现的软负载。HAProxy相比LVS的使用要简单很多，功能方面也很丰富。当前，<span style="color: #3366ff;">HAProxy支持两种主要的代理模式:"tcp"也即4层（大多用于邮件服务器、内部协议通信服务器等），和7层（HTTP）。在4层模式 下，HAProxy仅在客户端和服务器之间转发双向流量。7层模式下，HAProxy会分析协议，并且能通过允许、拒绝、交换、增加、修改或者删除请求 (request)或者回应(response)里指定内容来控制协议，这种操作要基于特定规则。</span></p>
<p>现在用<span style="color: #800000;">HAProxy主要在于它有以下优点</span>：</p>
<div class="cnblogs_Highlighter sh-gutter">
<div><div id="highlighter_64803" class="syntaxhighlighter  bash"><div class="toolbar"><span><a href="#" class="toolbar_item command_help help">?</a></span></div><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div><div class="line number3 index2 alt2">3</div><div class="line number4 index3 alt1">4</div><div class="line number5 index4 alt2">5</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="bash plain">1）免费开源，稳定性也是非常好，这个可通过我做的一些小项目可以看出来，单Haproxy也跑得不错，稳定性可以与LVS相媲美；</code></div><div class="line number2 index1 alt1"><code class="bash plain">2）根据官方文档，HAProxy可以跑满10Gbps-New benchmark of HAProxy at 10 Gbps using Myricom's 10GbE NICs (Myri-10G PCI-Express)，这个作为软件级负载均衡，也是比较惊人的；</code></div><div class="line number3 index2 alt2"><code class="bash plain">3）HAProxy可以作为MySQL、邮件或其它的非web的负载均衡，我们常用于它作为MySQL(读)负载均衡；</code></div><div class="line number4 index3 alt1"><code class="bash plain">4）自带强大的监控服务器状态的页面，实际环境中我们结合Nagios进行邮件或短信报警，这个也是我非常喜欢它的原因之一；</code></div><div class="line number5 index4 alt2"><code class="bash plain">5）HAProxy支持虚拟主机。</code></div></div></td></tr></tbody></table></div></div>
</div>
<p><strong><span style="color: #0000ff;">HAProxy介绍</span></strong><br>反向代理服务器,支持双机热备支持虚拟主机,但其配置简单,拥有非常不错的服务器健康检查功能,当其代理的后端服务器出现故障, HAProxy会自动将该服务器摘除,故障恢复后再自动将该服务器加入｡新的1.3引入了frontend,backend；frontend根据任意 HTTP请求头内容做规则匹配,然后把请求定向到相关的backend.</p>
<p><span style="color: #0000ff;"><strong>keepalived简介　</strong></span>　<br>keepalived是一个类似于layer3, 4 &amp; 5交换机制的软件，也就是我们平时说的第3层、第4层和第5层交换。Keepalived的作用是检测web服务器的状态，如果有一台web服务器死机，或工作出现故障，Keepalived将检测到，并将有故障的web服务器从系统中剔除，当web服务器工作正常后Keepalived自动将web服务器加入到服务器群中，这些工作全部自动完成，不需要人工干涉，需要人工做的只是修复故障的web服务器。<br>类似的HA工具还有heatbeat、drbd等，heatbeat、drbd配置都较为复杂。</p>
<p><strong><span style="color: #0000ff;">keepalived工作原理</span></strong><br>keepalived可提供vrrp以及health-check功能，可以只用它提供双机浮动的vip（vrrp虚拟路由功能），这样可以简单实现一个双机热备高可用功能。<br>keepalived是一个类似于layer3, 4，5交换机制的软件，也就是我们平时说的第3层、第4层和第5层交换。Keepalived的作用是检测web 服务器的状态。 Layer3,4&amp;5工作在IP/TCP协议栈的IP层，TCP层，及应用层,原理分别如下：</p>
<div class="cnblogs_Highlighter sh-gutter">
<div><div id="highlighter_955595" class="syntaxhighlighter  bash"><div class="toolbar"><span><a href="#" class="toolbar_item command_help help">?</a></span></div><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div><div class="line number3 index2 alt2">3</div><div class="line number4 index3 alt1">4</div><div class="line number5 index4 alt2">5</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="bash plain">Layer3：Keepalived使用Layer3的方式工作式时，Keepalived会定期向服务器群中的服务器发送一个ICMP的数据包（既我们平时用的Ping程序）,如果发现某台服务的IP地址没有激活，Keepalived便报告这台服务器失效，并将它从服务器群中剔除，这种情况的典型例子是某台服务器被非法关机。Layer3的方式是以服务器的IP地址是否有效作为服务器工作正常与否的标准。在本文中将采用这种方式。</code></div><div class="line number2 index1 alt1"><code class="bash plain">Layer4:如果您理解了Layer3的方式，Layer4就容易了。Layer4主要以TCP端口的状态来决定服务器工作正常与否。如web server的服务端口一般是80，如果Keepalived检测到80端口没有启动，则Keepalived将把这台服务器从服务器群中剔除。</code></div><div class="line number3 index2 alt2"><code class="bash plain">Layer5：Layer5就是工作在具体的应用层了，比Layer3,Layer4要复杂一点，在网络上占用的带宽也要大一些。Keepalived将根据用户的设定检查服务器程序的运行是否正常，如果与用户的设定不相符，则Keepalived将把服务器从服务器群中剔除。</code></div><div class="line number4 index3 alt1">&nbsp;</div><div class="line number5 index4 alt2"><code class="bash plain">vip即虚拟ip，是附在主机网卡上的，即对主机网卡进行虚拟，此IP仍然是占用了此网段的某个IP。</code></div></div></td></tr></tbody></table></div></div>
</div>
<p><strong><span style="color: #0000ff;">keepalived作用</span></strong><br>随着网站业务量的增长，网站的服务器压力越来越大，需要负载均衡方案！商业的硬件如F5又太贵，创业型互联公司如何有效节约成本，节省不必要的浪费呢？同时实现商业硬件一样的高性能高可用的功能？有什么好的负载均衡可伸张可扩展的方案吗？答案是肯定的！有！可以利用Haproxy+Keepalived基于完整开源软件的架构可以为你提供一个负载均衡及高可用的服务器。<br><span style="color: #800080;">Keepalived的作用是检测web服务器的状态，如果有一台web服务器死机，或工作出现故障，Keepalived将检测到，并将有故障的web服务器从系统中剔除，当web服务器工作正常后Keepalived自动将web服务器加入到服务器群中，这些工作全部自动完成，不需要人工干涉，需要人工做的只是修复故障的web服务器。</span></p>
<p>Keepalived是一个基于VRRP协议来实现的WEB 服务高可用方案，可以利用其来避免单点故障。一个WEB服务至少会有2台服务器运行Keepalived，一台为主服务器（MASTER），一台为备份服务器（BACKUP），但是对外表现为一个虚拟IP，主服务器会发送特定的消息给备份服务器，当备份服务器收不到这个消息的时候，即主服务器宕机的时候，备份服务器就会接管虚拟IP，继续提供服务，从而保证了高可用性。keepalived是VRRP的完美实现！</p>
<p><img src="https://images2015.cnblogs.com/blog/907596/201704/907596-20170426180221225-427604998.png" alt=""></p>
<p><strong><span style="color: #0000ff;">VRRP协议简介</span></strong><br>在现实的网络环境中，两台需要通信的主机大多数情况下并没有直接的物理连接。对于这样的情况，它们之间路由怎样选择？主机如何选定到达目的主机的下一跳路由，这个问题通常的解决方法有二种：</p>
<div class="cnblogs_Highlighter sh-gutter">
<div><div id="highlighter_65111" class="syntaxhighlighter  bash"><div class="toolbar"><span><a href="#" class="toolbar_item command_help help">?</a></span></div><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="bash plain">1）在主机上使用动态路由协议(RIP、OSPF等)</code></div><div class="line number2 index1 alt1"><code class="bash plain">2）在主机上配置静态路由</code></div></div></td></tr></tbody></table></div></div>
</div>
<p>很明显在主机上配置路态路由是非常不切实际的，因为管理、维护成本以及是否支持等诸多问题，配置静态路由就变得十分流行，但路由器(或者说默认网关default gateway)却经常成为单点。<br>VRRP的目的就是为了解决静态路由单点故障问题。VRRP通过一竞选(election)协议来动态的将路由任务交给LAN中虚拟路由器中的某台VRRP路由器。</p>
<p><strong><span style="color: #0000ff;">VRRP工作机制</span></strong><br>在一个VRRP虚拟路由器中，有多台物理的VRRP路由器，但是这多台的物理的机器并不能同时工作，而是由一台称为MASTER的负责路由工作，其它的都是BACKUP，MASTER并非一成不变，VRRP让每个VRRP路由器参与竞选，最终获胜的就是MASTER。MASTER拥有一些特权，比如 拥有虚拟路由器的IP地址，我们的主机就是用这个IP地址作为静态路由的。拥有特权的MASTER要负责转发发送给网关地址的包和响应ARP请求。<br>VRRP通过竞选协议来实现虚拟路由器的功能，所有的协议报文都是通过IP多播(multicast)包(多播地址 224.0.0.18)形式发送的。虚拟路由器由VRID(范围0-255)和一组IP地址组成，对外表现为一个周知的MAC地址。所以，在一个虚拟路由 器中，不管谁是MASTER，对外都是相同的MAC和IP(称之为VIP)。客户端主机并不需要因为MASTER的改变而修改自己的路由配置，对他们来 说，这种主从的切换是透明的。<br>在一个虚拟路由器中，只有作为MASTER的VRRP路由器会一直发送VRRP广告包(VRRPAdvertisement message)，BACKUP不会抢占MASTER，除非它的优先级(priority)更高。当MASTER不可用时(BACKUP收不到广告包)， 多台BACKUP中优先级最高的这台会被抢占为MASTER。这种抢占是非常快速的(&lt;1s)，以保证服务的连续性。由于安全性考虑，VRRP包使用了加密协议进行加密。</p>
<p><span style="color: #ff00ff;">----------------------------------------------------------------------------------------------------------------------------------------------------</span><br>Haproxy+Keepalived的负载均衡和高可用环境的部署过程，有主从和主主两种模式：</p>
<div class="cnblogs_Highlighter sh-gutter">
<div><div id="highlighter_718740" class="syntaxhighlighter  bash"><div class="toolbar"><span><a href="#" class="toolbar_item command_help help">?</a></span></div><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div><div class="line number3 index2 alt2">3</div><div class="line number4 index3 alt1">4</div><div class="line number5 index4 alt2">5</div><div class="line number6 index5 alt1">6</div><div class="line number7 index6 alt2">7</div><div class="line number8 index7 alt1">8</div><div class="line number9 index8 alt2">9</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="bash plain">主从模式：一个vip，vip在master机器上，当master机器出现故障后，vip漂移到slave机器上，slave变为master提供服务。</code></div><div class="line number2 index1 alt1"><code class="bash plain">主主模式：两个vip，两台机器都设置vip，当其中一台机器出现故障后，它的vip就漂移到另一台机器上（即另一台机器有两个vip），当故障机器恢复后，再将vip重新漂移过来。</code></div><div class="line number3 index2 alt2"><code class="bash spaces">&nbsp;</code>&nbsp;</div><div class="line number4 index3 alt1"><code class="bash plain">各自作用：</code></div><div class="line number5 index4 alt2"><code class="bash plain">1）Keepalived 的作用是检测web服务器的状态，如果有一台web服务器死机，或工作出现故障，Keepalived将检测到，并将有故障的web服务器从系统中剔除， 当web服务器工作正常</code></div><div class="line number6 index5 alt1"><code class="bash spaces">&nbsp;&nbsp;</code><code class="bash plain">后Keepalived自动将web服务器加入到服务器群中，这些工作全部自动完成，不需要人工干涉，需要人工做的只是修复故障的 web服务器。</code></div><div class="line number7 index6 alt2"><code class="bash plain">2）HAProxy 提供高可用性、负载均衡以及基于TCP和HTTP应用的代理,支持虚拟主机,它是免费、快速并且可靠的一种解决方案。HAProxy 特别适用于那些负载特大的 web 站点, 这些</code></div><div class="line number8 index7 alt1"><code class="bash spaces">&nbsp;&nbsp;</code><code class="bash plain">站点通常又需要会话保持或七层处理。HAProxy 运行在当前的硬件上,完全可以支持数以万计的并发连接。并且它的运行模式使得它可以很简单安全的整 合进您当前的架构中, 同时</code></div><div class="line number9 index8 alt2"><code class="bash spaces">&nbsp;&nbsp;</code><code class="bash plain">可以保护你的 web 服务器不被暴露到网络上。</code></div></div></td></tr></tbody></table></div></div>
</div>
<p><span style="font-size: 18px; color: #000000; background-color: #ffff99;"><strong>一、Haproxy+Keepalived主主架构部署记录</strong></span></p>
<p><strong><span style="color: #ff00ff; background-color: #ffffff;">0）需求描述：</span></strong></p>
<div class="cnblogs_Highlighter sh-gutter">
<div><div id="highlighter_810664" class="syntaxhighlighter  bash"><div class="toolbar"><span><a href="#" class="toolbar_item command_help help">?</a></span></div><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div><div class="line number3 index2 alt2">3</div><div class="line number4 index3 alt1">4</div><div class="line number5 index4 alt2">5</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="bash plain">网站的域名之前都是放在机房的两台服务器上，前面做CDN加速，CDN节点会同步缓存到网站数据，用户访问网站，流量压力都在前面的CDN设备上。</code></div><div class="line number2 index1 alt1"><code class="bash plain">后续网站服务器被攻击，又在CDN前面加了一个上层，即又多加一层缓存，刚加这个上层的时候，流量回源会很大，访问量也会减少，不过随着回源，访问量渐渐恢复。</code></div><div class="line number3 index2 alt2">&nbsp;</div><div class="line number4 index3 alt1"><code class="bash plain">后来为了安全考虑，计划做Keepalivedd+Haproxy负载均衡的高可用，部署好之后，可以将后端源站服务器的外网ip拿下，进来的请求通过Haproxy代理进来，出去的请求可以通过squid代理出去。</code></div><div class="line number5 index4 alt2"><code class="bash plain">后端源站机器的web端口只需要对Haproxy机器开放即可，然后CDN解析那边将源站ip改为Haproxy服务器ip即可。</code></div></div></td></tr></tbody></table></div></div>
</div>
<p><strong><span style="color: #ff00ff; background-color: #ffffff;">1）环境准备</span></strong></p>
<div class="cnblogs_Highlighter sh-gutter">
<div><div id="highlighter_193834" class="syntaxhighlighter  bash"><div class="toolbar"><span><a href="#" class="toolbar_item command_help help">?</a></span></div><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div><div class="line number3 index2 alt2">3</div><div class="line number4 index3 alt1">4</div><div class="line number5 index4 alt2">5</div><div class="line number6 index5 alt1">6</div><div class="line number7 index6 alt2">7</div><div class="line number8 index7 alt1">8</div><div class="line number9 index8 alt2">9</div><div class="line number10 index9 alt1">10</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="bash plain">Haproxy_Keepalived_Master&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 182.148.15.237</code></div><div class="line number2 index1 alt1"><code class="bash plain">VIP1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 182.148.15.239</code></div><div class="line number3 index2 alt2">&nbsp;</div><div class="line number4 index3 alt1"><code class="bash plain">Haproxy_Keepalived_Backup&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 182.148.15.236</code></div><div class="line number5 index4 alt2"><code class="bash plain">VIP2&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 182.148.15.235</code></div><div class="line number6 index5 alt1">&nbsp;</div><div class="line number7 index6 alt2"><code class="bash plain">Real_Server1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 182.148.15.233</code></div><div class="line number8 index7 alt1"><code class="bash plain">Real_Server2&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 182.148.15.238</code></div><div class="line number9 index8 alt2">&nbsp;</div><div class="line number10 index9 alt1"><code class="bash plain">系统版本都是centos6.8</code></div></div></td></tr></tbody></table></div></div>
</div>
<p>基本的网络拓扑图如下：</p>
<p><img src="https://images2015.cnblogs.com/blog/907596/201704/907596-20170426191536037-792982518.png" alt=""></p>
<p><strong><span style="color: #ff00ff;">2）Haproxy_keepalived_Master和<strong>Haproxy_keepalived_Backup两台</strong>服务器上安装配置haproxy和keepalived的操作记录：</span></strong></p>
<div class="cnblogs_Highlighter sh-gutter">
<div><div id="highlighter_655028" class="syntaxhighlighter  bash"><div class="toolbar"><span><a href="#" class="toolbar_item command_help help">?</a></span></div><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div><div class="line number3 index2 alt2">3</div><div class="line number4 index3 alt1">4</div><div class="line number5 index4 alt2">5</div><div class="line number6 index5 alt1">6</div><div class="line number7 index6 alt2">7</div><div class="line number8 index7 alt1">8</div><div class="line number9 index8 alt2">9</div><div class="line number10 index9 alt1">10</div><div class="line number11 index10 alt2">11</div><div class="line number12 index11 alt1">12</div><div class="line number13 index12 alt2">13</div><div class="line number14 index13 alt1">14</div><div class="line number15 index14 alt2">15</div><div class="line number16 index15 alt1">16</div><div class="line number17 index16 alt2">17</div><div class="line number18 index17 alt1">18</div><div class="line number19 index18 alt2">19</div><div class="line number20 index19 alt1">20</div><div class="line number21 index20 alt2">21</div><div class="line number22 index21 alt1">22</div><div class="line number23 index22 alt2">23</div><div class="line number24 index23 alt1">24</div><div class="line number25 index24 alt2">25</div><div class="line number26 index25 alt1">26</div><div class="line number27 index26 alt2">27</div><div class="line number28 index27 alt1">28</div><div class="line number29 index28 alt2">29</div><div class="line number30 index29 alt1">30</div><div class="line number31 index30 alt2">31</div><div class="line number32 index31 alt1">32</div><div class="line number33 index32 alt2">33</div><div class="line number34 index33 alt1">34</div><div class="line number35 index34 alt2">35</div><div class="line number36 index35 alt1">36</div><div class="line number37 index36 alt2">37</div><div class="line number38 index37 alt1">38</div><div class="line number39 index38 alt2">39</div><div class="line number40 index39 alt1">40</div><div class="line number41 index40 alt2">41</div><div class="line number42 index41 alt1">42</div><div class="line number43 index42 alt2">43</div><div class="line number44 index43 alt1">44</div><div class="line number45 index44 alt2">45</div><div class="line number46 index45 alt1">46</div><div class="line number47 index46 alt2">47</div><div class="line number48 index47 alt1">48</div><div class="line number49 index48 alt2">49</div><div class="line number50 index49 alt1">50</div><div class="line number51 index50 alt2">51</div><div class="line number52 index51 alt1">52</div><div class="line number53 index52 alt2">53</div><div class="line number54 index53 alt1">54</div><div class="line number55 index54 alt2">55</div><div class="line number56 index55 alt1">56</div><div class="line number57 index56 alt2">57</div><div class="line number58 index57 alt1">58</div><div class="line number59 index58 alt2">59</div><div class="line number60 index59 alt1">60</div><div class="line number61 index60 alt2">61</div><div class="line number62 index61 alt1">62</div><div class="line number63 index62 alt2">63</div><div class="line number64 index63 alt1">64</div><div class="line number65 index64 alt2">65</div><div class="line number66 index65 alt1">66</div><div class="line number67 index66 alt2">67</div><div class="line number68 index67 alt1">68</div><div class="line number69 index68 alt2">69</div><div class="line number70 index69 alt1">70</div><div class="line number71 index70 alt2">71</div><div class="line number72 index71 alt1">72</div><div class="line number73 index72 alt2">73</div><div class="line number74 index73 alt1">74</div><div class="line number75 index74 alt2">75</div><div class="line number76 index75 alt1">76</div><div class="line number77 index76 alt2">77</div><div class="line number78 index77 alt1">78</div><div class="line number79 index78 alt2">79</div><div class="line number80 index79 alt1">80</div><div class="line number81 index80 alt2">81</div><div class="line number82 index81 alt1">82</div><div class="line number83 index82 alt2">83</div><div class="line number84 index83 alt1">84</div><div class="line number85 index84 alt2">85</div><div class="line number86 index85 alt1">86</div><div class="line number87 index86 alt2">87</div><div class="line number88 index87 alt1">88</div><div class="line number89 index88 alt2">89</div><div class="line number90 index89 alt1">90</div><div class="line number91 index90 alt2">91</div><div class="line number92 index91 alt1">92</div><div class="line number93 index92 alt2">93</div><div class="line number94 index93 alt1">94</div><div class="line number95 index94 alt2">95</div><div class="line number96 index95 alt1">96</div><div class="line number97 index96 alt2">97</div><div class="line number98 index97 alt1">98</div><div class="line number99 index98 alt2">99</div><div class="line number100 index99 alt1">100</div><div class="line number101 index100 alt2">101</div><div class="line number102 index101 alt1">102</div><div class="line number103 index102 alt2">103</div><div class="line number104 index103 alt1">104</div><div class="line number105 index104 alt2">105</div><div class="line number106 index105 alt1">106</div><div class="line number107 index106 alt2">107</div><div class="line number108 index107 alt1">108</div><div class="line number109 index108 alt2">109</div><div class="line number110 index109 alt1">110</div><div class="line number111 index110 alt2">111</div><div class="line number112 index111 alt1">112</div><div class="line number113 index112 alt2">113</div><div class="line number114 index113 alt1">114</div><div class="line number115 index114 alt2">115</div><div class="line number116 index115 alt1">116</div><div class="line number117 index116 alt2">117</div><div class="line number118 index117 alt1">118</div><div class="line number119 index118 alt2">119</div><div class="line number120 index119 alt1">120</div><div class="line number121 index120 alt2">121</div><div class="line number122 index121 alt1">122</div><div class="line number123 index122 alt2">123</div><div class="line number124 index123 alt1">124</div><div class="line number125 index124 alt2">125</div><div class="line number126 index125 alt1">126</div><div class="line number127 index126 alt2">127</div><div class="line number128 index127 alt1">128</div><div class="line number129 index128 alt2">129</div><div class="line number130 index129 alt1">130</div><div class="line number131 index130 alt2">131</div><div class="line number132 index131 alt1">132</div><div class="line number133 index132 alt2">133</div><div class="line number134 index133 alt1">134</div><div class="line number135 index134 alt2">135</div><div class="line number136 index135 alt1">136</div><div class="line number137 index136 alt2">137</div><div class="line number138 index137 alt1">138</div><div class="line number139 index138 alt2">139</div><div class="line number140 index139 alt1">140</div><div class="line number141 index140 alt2">141</div><div class="line number142 index141 alt1">142</div><div class="line number143 index142 alt2">143</div><div class="line number144 index143 alt1">144</div><div class="line number145 index144 alt2">145</div><div class="line number146 index145 alt1">146</div><div class="line number147 index146 alt2">147</div><div class="line number148 index147 alt1">148</div><div class="line number149 index148 alt2">149</div><div class="line number150 index149 alt1">150</div><div class="line number151 index150 alt2">151</div><div class="line number152 index151 alt1">152</div><div class="line number153 index152 alt2">153</div><div class="line number154 index153 alt1">154</div><div class="line number155 index154 alt2">155</div><div class="line number156 index155 alt1">156</div><div class="line number157 index156 alt2">157</div><div class="line number158 index157 alt1">158</div><div class="line number159 index158 alt2">159</div><div class="line number160 index159 alt1">160</div><div class="line number161 index160 alt2">161</div><div class="line number162 index161 alt1">162</div><div class="line number163 index162 alt2">163</div><div class="line number164 index163 alt1">164</div><div class="line number165 index164 alt2">165</div><div class="line number166 index165 alt1">166</div><div class="line number167 index166 alt2">167</div><div class="line number168 index167 alt1">168</div><div class="line number169 index168 alt2">169</div><div class="line number170 index169 alt1">170</div><div class="line number171 index170 alt2">171</div><div class="line number172 index171 alt1">172</div><div class="line number173 index172 alt2">173</div><div class="line number174 index173 alt1">174</div><div class="line number175 index174 alt2">175</div><div class="line number176 index175 alt1">176</div><div class="line number177 index176 alt2">177</div><div class="line number178 index177 alt1">178</div><div class="line number179 index178 alt2">179</div><div class="line number180 index179 alt1">180</div><div class="line number181 index180 alt2">181</div><div class="line number182 index181 alt1">182</div><div class="line number183 index182 alt2">183</div><div class="line number184 index183 alt1">184</div><div class="line number185 index184 alt2">185</div><div class="line number186 index185 alt1">186</div><div class="line number187 index186 alt2">187</div><div class="line number188 index187 alt1">188</div><div class="line number189 index188 alt2">189</div><div class="line number190 index189 alt1">190</div><div class="line number191 index190 alt2">191</div><div class="line number192 index191 alt1">192</div><div class="line number193 index192 alt2">193</div><div class="line number194 index193 alt1">194</div><div class="line number195 index194 alt2">195</div><div class="line number196 index195 alt1">196</div><div class="line number197 index196 alt2">197</div><div class="line number198 index197 alt1">198</div><div class="line number199 index198 alt2">199</div><div class="line number200 index199 alt1">200</div><div class="line number201 index200 alt2">201</div><div class="line number202 index201 alt1">202</div><div class="line number203 index202 alt2">203</div><div class="line number204 index203 alt1">204</div><div class="line number205 index204 alt2">205</div><div class="line number206 index205 alt1">206</div><div class="line number207 index206 alt2">207</div><div class="line number208 index207 alt1">208</div><div class="line number209 index208 alt2">209</div><div class="line number210 index209 alt1">210</div><div class="line number211 index210 alt2">211</div><div class="line number212 index211 alt1">212</div><div class="line number213 index212 alt2">213</div><div class="line number214 index213 alt1">214</div><div class="line number215 index214 alt2">215</div><div class="line number216 index215 alt1">216</div><div class="line number217 index216 alt2">217</div><div class="line number218 index217 alt1">218</div><div class="line number219 index218 alt2">219</div><div class="line number220 index219 alt1">220</div><div class="line number221 index220 alt2">221</div><div class="line number222 index221 alt1">222</div><div class="line number223 index222 alt2">223</div><div class="line number224 index223 alt1">224</div><div class="line number225 index224 alt2">225</div><div class="line number226 index225 alt1">226</div><div class="line number227 index226 alt2">227</div><div class="line number228 index227 alt1">228</div><div class="line number229 index228 alt2">229</div><div class="line number230 index229 alt1">230</div><div class="line number231 index230 alt2">231</div><div class="line number232 index231 alt1">232</div><div class="line number233 index232 alt2">233</div><div class="line number234 index233 alt1">234</div><div class="line number235 index234 alt2">235</div><div class="line number236 index235 alt1">236</div><div class="line number237 index236 alt2">237</div><div class="line number238 index237 alt1">238</div><div class="line number239 index238 alt2">239</div><div class="line number240 index239 alt1">240</div><div class="line number241 index240 alt2">241</div><div class="line number242 index241 alt1">242</div><div class="line number243 index242 alt2">243</div><div class="line number244 index243 alt1">244</div><div class="line number245 index244 alt2">245</div><div class="line number246 index245 alt1">246</div><div class="line number247 index246 alt2">247</div><div class="line number248 index247 alt1">248</div><div class="line number249 index248 alt2">249</div><div class="line number250 index249 alt1">250</div><div class="line number251 index250 alt2">251</div><div class="line number252 index251 alt1">252</div><div class="line number253 index252 alt2">253</div><div class="line number254 index253 alt1">254</div><div class="line number255 index254 alt2">255</div><div class="line number256 index255 alt1">256</div><div class="line number257 index256 alt2">257</div><div class="line number258 index257 alt1">258</div><div class="line number259 index258 alt2">259</div><div class="line number260 index259 alt1">260</div><div class="line number261 index260 alt2">261</div><div class="line number262 index261 alt1">262</div><div class="line number263 index262 alt2">263</div><div class="line number264 index263 alt1">264</div><div class="line number265 index264 alt2">265</div><div class="line number266 index265 alt1">266</div><div class="line number267 index266 alt2">267</div><div class="line number268 index267 alt1">268</div><div class="line number269 index268 alt2">269</div><div class="line number270 index269 alt1">270</div><div class="line number271 index270 alt2">271</div><div class="line number272 index271 alt1">272</div><div class="line number273 index272 alt2">273</div><div class="line number274 index273 alt1">274</div><div class="line number275 index274 alt2">275</div><div class="line number276 index275 alt1">276</div><div class="line number277 index276 alt2">277</div><div class="line number278 index277 alt1">278</div><div class="line number279 index278 alt2">279</div><div class="line number280 index279 alt1">280</div><div class="line number281 index280 alt2">281</div><div class="line number282 index281 alt1">282</div><div class="line number283 index282 alt2">283</div><div class="line number284 index283 alt1">284</div><div class="line number285 index284 alt2">285</div><div class="line number286 index285 alt1">286</div><div class="line number287 index286 alt2">287</div><div class="line number288 index287 alt1">288</div><div class="line number289 index288 alt2">289</div><div class="line number290 index289 alt1">290</div><div class="line number291 index290 alt2">291</div><div class="line number292 index291 alt1">292</div><div class="line number293 index292 alt2">293</div><div class="line number294 index293 alt1">294</div><div class="line number295 index294 alt2">295</div><div class="line number296 index295 alt1">296</div><div class="line number297 index296 alt2">297</div><div class="line number298 index297 alt1">298</div><div class="line number299 index298 alt2">299</div><div class="line number300 index299 alt1">300</div><div class="line number301 index300 alt2">301</div><div class="line number302 index301 alt1">302</div><div class="line number303 index302 alt2">303</div><div class="line number304 index303 alt1">304</div><div class="line number305 index304 alt2">305</div><div class="line number306 index305 alt1">306</div><div class="line number307 index306 alt2">307</div><div class="line number308 index307 alt1">308</div><div class="line number309 index308 alt2">309</div><div class="line number310 index309 alt1">310</div><div class="line number311 index310 alt2">311</div><div class="line number312 index311 alt1">312</div><div class="line number313 index312 alt2">313</div><div class="line number314 index313 alt1">314</div><div class="line number315 index314 alt2">315</div><div class="line number316 index315 alt1">316</div><div class="line number317 index316 alt2">317</div><div class="line number318 index317 alt1">318</div><div class="line number319 index318 alt2">319</div><div class="line number320 index319 alt1">320</div><div class="line number321 index320 alt2">321</div><div class="line number322 index321 alt1">322</div><div class="line number323 index322 alt2">323</div><div class="line number324 index323 alt1">324</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="bash plain">--------------------------------------------------------------------------------------------------------------------------</code></div><div class="line number2 index1 alt1"><code class="bash plain">关闭 SElinux、配置防火墙（Haproxy_Keepalived_Master 和 Haproxy_Keepalived_Backup两台机器都要操作）</code></div><div class="line number3 index2 alt2"><code class="bash plain">[root@Haproxy_Keepalived_Master ~]</code><code class="bash comments"># vim /etc/sysconfig/selinux</code></div><div class="line number4 index3 alt1"><code class="bash comments">#SELINUX=enforcing&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; #注释掉</code></div><div class="line number5 index4 alt2"><code class="bash comments">#SELINUXTYPE=targeted&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; #注释掉</code></div><div class="line number6 index5 alt1"><code class="bash plain">SELINUX=disabled&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </code><code class="bash comments">#增加</code></div><div class="line number7 index6 alt2">&nbsp;</div><div class="line number8 index7 alt1"><code class="bash plain">[root@Haproxy_Keepalived_Master ~]</code><code class="bash comments"># setenforce 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; #临时关闭selinux。上面文件配置后，重启机器后就永久生效。</code></div><div class="line number9 index8 alt2">&nbsp;</div><div class="line number10 index9 alt1"><code class="bash plain">注意下面182.148.15.0</code><code class="bash plain">/24</code><code class="bash plain">是服务器的公网网段，192.168.1.0</code><code class="bash plain">/24</code><code class="bash plain">是服务器的私网网段</code></div><div class="line number11 index10 alt2"><code class="bash plain">一定要注意：加上这个组播规则后，MASTER和BACKUP故障时，才能实现VIP资源的正常转移。其故障恢复后，VIP也还会正常转移回来。</code></div><div class="line number12 index11 alt1"><code class="bash plain">[root@Haproxy_Keepalived_Master ~]</code><code class="bash comments"># vim /etc/sysconfig/iptables&nbsp;&nbsp;&nbsp; </code></div><div class="line number13 index12 alt2"><code class="bash plain">.......</code></div><div class="line number14 index13 alt1"><code class="bash plain">-A INPUT -s 182.148.15.0</code><code class="bash plain">/24</code> <code class="bash plain">-d 224.0.0.18 -j ACCEPT&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </code><code class="bash comments">#允许组播地址通信。 </code></div><div class="line number15 index14 alt2"><code class="bash plain">-A INPUT -s 192.168.1.0</code><code class="bash plain">/24</code> <code class="bash plain">-d 224.0.0.18 -j ACCEPT</code></div><div class="line number16 index15 alt1"><code class="bash plain">-A INPUT -s 182.148.15.0</code><code class="bash plain">/24</code> <code class="bash plain">-p vrrp -j ACCEPT&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </code><code class="bash comments">#允许 VRRP（虚拟路由器冗余协）通信</code></div><div class="line number17 index16 alt2"><code class="bash plain">-A INPUT -s 192.168.1.0</code><code class="bash plain">/24</code> <code class="bash plain">-p vrrp -j ACCEPT</code></div><div class="line number18 index17 alt1"><code class="bash plain">-A INPUT -m state --state NEW -m tcp -p tcp --dport 80 -j ACCEPT </code></div><div class="line number19 index18 alt2">&nbsp;</div><div class="line number20 index19 alt1"><code class="bash plain">[root@Haproxy_Keepalived_Master ~]</code><code class="bash comments"># /etc/init.d/iptables restart</code></div><div class="line number21 index20 alt2">&nbsp;</div><div class="line number22 index21 alt1">&nbsp;</div><div class="line number23 index22 alt2"><code class="bash plain">----------------------------------------------------------------------------------------------------------------------</code></div><div class="line number24 index23 alt1"><code class="bash plain">下载Haproxy地址：http:</code><code class="bash plain">//www</code><code class="bash plain">.haproxy.org</code><code class="bash plain">/download/1</code><code class="bash plain">.6</code><code class="bash plain">/src/</code></div><div class="line number25 index24 alt2">&nbsp;</div><div class="line number26 index25 alt1"><code class="bash plain">1）安装Haproxy（Haproxy_Keepalived_Master 和 Haproxy_Keepalived_Backup两台机器都要操作）&nbsp; 注意：安装之前，先执行yum </code><code class="bash functions">install</code> <code class="bash functions">gcc</code> <code class="bash functions">gcc</code><code class="bash plain">-c++ </code><code class="bash functions">make</code> <code class="bash plain">openssl-devel kernel-devel</code></div><div class="line number27 index26 alt2"><code class="bash plain">[root@Haproxy_Keepalived_Master src]</code><code class="bash comments"># wget http://www.haproxy.org/download/1.6/src/haproxy-1.6.12.tar.gz</code></div><div class="line number28 index27 alt1"><code class="bash plain">[root@Haproxy_Keepalived_Master src]</code><code class="bash comments"># tar -zvxf haproxy-1.6.12.tar.gz</code></div><div class="line number29 index28 alt2"><code class="bash plain">[root@Haproxy_Keepalived_Master src]</code><code class="bash comments"># cd haproxy-1.6.12</code></div><div class="line number30 index29 alt1"><code class="bash plain">[root@Haproxy_Keepalived_Master haproxy-1.6.12]</code><code class="bash comments"># make TARGET=linux26 CPU=x86_64 PREFIX=/usr/local/haprpxy USE_OPENSSL=1 ADDLIB=-lz</code></div><div class="line number31 index30 alt2">&nbsp;</div><div class="line number32 index31 alt1"><code class="bash plain">参数说明：</code></div><div class="line number33 index32 alt2"><code class="bash plain">TARGET=linux26&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </code><code class="bash comments">#使用 uname -r 查看内核，如：2.6.32-642.el6.x86_64，此时该参数就为linux26</code></div><div class="line number34 index33 alt1"><code class="bash plain">CPU=x86_64&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </code><code class="bash comments">#使用 uname -r 查看系统信息，如 x86_64 GNU/Linux，此时该参数就为 x86_64</code></div><div class="line number35 index34 alt2"><code class="bash plain">PREFIX=</code><code class="bash plain">/usr/local/haprpxy</code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <code class="bash comments">#haprpxy 安装路径</code></div><div class="line number36 index35 alt1">&nbsp;</div><div class="line number37 index36 alt2"><code class="bash plain">[root@Haproxy_Keepalived_Master haproxy-1.6.12]</code><code class="bash comments"># ldd haproxy | grep ssl</code></div><div class="line number38 index37 alt1"><code class="bash spaces">&nbsp;&nbsp;</code><code class="bash plain">libssl.so.10 =&gt; </code><code class="bash plain">/usr/lib64/libssl</code><code class="bash plain">.so.10 (0x00007f6f3d9b2000)</code></div><div class="line number39 index38 alt2"><code class="bash plain">[root@Haproxy_Keepalived_Master haproxy-1.6.12]</code><code class="bash comments"># make install PREFIX=/usr/local/haproxy</code></div><div class="line number40 index39 alt1"><code class="bash spaces">&nbsp;&nbsp;</code>&nbsp;</div><div class="line number41 index40 alt2"><code class="bash plain">[root@Haproxy_Keepalived_Master haproxy-1.6.12]</code><code class="bash comments"># mkdir -p /usr/local/haproxy/conf</code></div><div class="line number42 index41 alt1"><code class="bash plain">[root@Haproxy_Keepalived_Master haproxy-1.6.12]</code><code class="bash comments"># mkdir -p /etc/haproxy</code></div><div class="line number43 index42 alt2"><code class="bash plain">[root@Haproxy_Keepalived_Master haproxy-1.6.12]</code><code class="bash comments"># cp /usr/local/src/haproxy-1.6.12/examples/option-http_proxy.cfg /usr/local/haproxy/conf/haproxy.cfg</code></div><div class="line number44 index43 alt1"><code class="bash plain">[root@Haproxy_Keepalived_Master haproxy-1.6.12]</code><code class="bash comments"># ln -s /usr/local/haproxy/conf/haproxy.cfg /etc/haproxy/haproxy.cfg</code></div><div class="line number45 index44 alt2"><code class="bash plain">[root@Haproxy_Keepalived_Master haproxy-1.6.12]</code><code class="bash comments"># cp -r /usr/local/src/haproxy-1.6.12/examples/errorfiles&nbsp; /usr/local/haproxy/errorfiles</code></div><div class="line number46 index45 alt1"><code class="bash plain">[root@Haproxy_Keepalived_Master haproxy-1.6.12]</code><code class="bash comments"># ln -s /usr/local/haproxy/errorfiles /etc/haproxy/errorfiles</code></div><div class="line number47 index46 alt2"><code class="bash plain">[root@Haproxy_Keepalived_Master haproxy-1.6.12]</code><code class="bash comments"># mkdir -p /usr/local/haproxy/log</code></div><div class="line number48 index47 alt1"><code class="bash plain">[root@Haproxy_Keepalived_Master haproxy-1.6.12]</code><code class="bash comments"># touch /usr/local/haproxy/log/haproxy.log</code></div><div class="line number49 index48 alt2"><code class="bash plain">[root@Haproxy_Keepalived_Master haproxy-1.6.12]</code><code class="bash comments"># ln -s /usr/local/haproxy/log/haproxy.log /var/log/haproxy.log</code></div><div class="line number50 index49 alt1"><code class="bash plain">[root@Haproxy_Keepalived_Master haproxy-1.6.12]</code><code class="bash comments"># cp /usr/local/src/haproxy-1.6.12/examples/haproxy.init /etc/rc.d/init.d/haproxy</code></div><div class="line number51 index50 alt2"><code class="bash plain">[root@Haproxy_Keepalived_Master haproxy-1.6.12]</code><code class="bash comments"># chmod +x /etc/rc.d/init.d/haproxy</code></div><div class="line number52 index51 alt1"><code class="bash plain">[root@Haproxy_Keepalived_Master haproxy-1.6.12]</code><code class="bash comments"># chkconfig haproxy on</code></div><div class="line number53 index52 alt2"><code class="bash plain">[root@Haproxy_Keepalived_Master haproxy-1.6.12]</code><code class="bash comments"># ln -s /usr/local/haproxy/sbin/haproxy /usr/sbin</code></div><div class="line number54 index53 alt1">&nbsp;</div><div class="line number55 index54 alt2"><code class="bash plain">2）配置 haproxy.cfg 参数（Haproxy_Keepalived_Master 和 Haproxy_Keepalived_Backup两台机器都要操作）</code></div><div class="line number56 index55 alt1"><code class="bash plain">[root@Haproxy_Keepalived_Master ~]</code><code class="bash comments"># cp /usr/local/haproxy/conf/haproxy.cfg /usr/local/haproxy/conf/haproxy.cfg.bak</code></div><div class="line number57 index56 alt2"><code class="bash plain">[root@Haproxy_Keepalived_Master ~]</code><code class="bash comments"># vim /usr/local/haproxy/conf/haproxy.cfg</code></div><div class="line number58 index57 alt1"><code class="bash plain">global&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </code></div><div class="line number59 index58 alt2"><code class="bash spaces">&nbsp;&nbsp;&nbsp;</code><code class="bash plain">log 127.0.0.1 local3 info&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </code><code class="bash comments">#在本机记录日志</code></div><div class="line number60 index59 alt1"><code class="bash spaces">&nbsp;&nbsp;&nbsp;</code><code class="bash plain">maxconn 65535&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </code><code class="bash comments">#每个进程可用的最大连接数</code></div><div class="line number61 index60 alt2"><code class="bash spaces">&nbsp;&nbsp;&nbsp;</code><code class="bash plain">chroot </code><code class="bash plain">/usr/local/haproxy</code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <code class="bash comments">#haproxy 安装目录</code></div><div class="line number62 index61 alt1"><code class="bash spaces">&nbsp;&nbsp;&nbsp;</code><code class="bash plain">uid 99&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </code><code class="bash comments">#运行haproxy的用户uid（cat /etc/passwd 查看，这里是nobody的uid）</code></div><div class="line number63 index62 alt2"><code class="bash spaces">&nbsp;&nbsp;&nbsp;</code><code class="bash plain">gid 99&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </code><code class="bash comments">#运行haproxy的用户组id（cat /etc/passwd 查看，这里是nobody组id）</code></div><div class="line number64 index63 alt1"><code class="bash spaces">&nbsp;&nbsp;&nbsp;</code><code class="bash plain">daemon&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </code><code class="bash comments">#以后台守护进程运行</code></div><div class="line number65 index64 alt2">&nbsp;</div><div class="line number66 index65 alt1"><code class="bash plain">defaults</code></div><div class="line number67 index66 alt2"><code class="bash spaces">&nbsp;&nbsp;&nbsp;</code><code class="bash plain">log global</code></div><div class="line number68 index67 alt1"><code class="bash spaces">&nbsp;&nbsp;&nbsp;</code><code class="bash plain">mode http&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </code><code class="bash comments">#运行模式 tcp、 http、 health</code></div><div class="line number69 index68 alt2"><code class="bash spaces">&nbsp;&nbsp;&nbsp;</code><code class="bash plain">retries 3&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </code><code class="bash comments">#三次连接失败，则判断服务不可用</code></div><div class="line number70 index69 alt1"><code class="bash spaces">&nbsp;&nbsp;&nbsp;</code><code class="bash plain">option redispatch&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </code><code class="bash comments">#如果后端有服务器宕机，强制切换到正常服务器</code></div><div class="line number71 index70 alt2"><code class="bash spaces">&nbsp;&nbsp;&nbsp;</code><code class="bash plain">stats uri </code><code class="bash plain">/haproxy</code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <code class="bash comments">#统计页面 URL 路径</code></div><div class="line number72 index71 alt1"><code class="bash spaces">&nbsp;&nbsp;&nbsp;</code><code class="bash plain">stats refresh 30s&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </code><code class="bash comments">#统计页面自动刷新时间</code></div><div class="line number73 index72 alt2"><code class="bash spaces">&nbsp;&nbsp;&nbsp;</code><code class="bash plain">stats realm haproxy-status&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </code><code class="bash comments">#统计页面输入密码框提示信息</code></div><div class="line number74 index73 alt1"><code class="bash spaces">&nbsp;&nbsp;&nbsp;</code><code class="bash plain">stats auth admin:dxInCtFianKtL]36&nbsp;&nbsp; </code><code class="bash comments">#统计页面用户名和密码</code></div><div class="line number75 index74 alt2"><code class="bash spaces">&nbsp;&nbsp;&nbsp;</code><code class="bash plain">stats hide-version&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </code><code class="bash comments">#隐藏统计页面上 HAProxy 版本信息</code></div><div class="line number76 index75 alt1"><code class="bash spaces">&nbsp;&nbsp;&nbsp;</code><code class="bash plain">maxconn 65535&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </code><code class="bash comments">#每个进程可用的最大连接数</code></div><div class="line number77 index76 alt2"><code class="bash spaces">&nbsp;&nbsp;&nbsp;</code><code class="bash plain">timeout connect 5000&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </code><code class="bash comments">#连接超时</code></div><div class="line number78 index77 alt1"><code class="bash spaces">&nbsp;&nbsp;&nbsp;</code><code class="bash plain">timeout client 50000&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </code><code class="bash comments">#客户端超时</code></div><div class="line number79 index78 alt2"><code class="bash spaces">&nbsp;&nbsp;&nbsp;</code><code class="bash plain">timeout server 50000&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </code><code class="bash comments">#服务器端超时</code></div><div class="line number80 index79 alt1">&nbsp;</div><div class="line number81 index80 alt2"><code class="bash plain">frontend http-</code><code class="bash keyword">in</code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <code class="bash comments">#自定义描述信息</code></div><div class="line number82 index81 alt1"><code class="bash spaces">&nbsp;&nbsp;&nbsp;</code><code class="bash plain">mode http&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </code><code class="bash comments">#运行模式 tcp、 http、 health</code></div><div class="line number83 index82 alt2"><code class="bash spaces">&nbsp;&nbsp;&nbsp;</code><code class="bash plain">maxconn 65535&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </code><code class="bash comments">#每个进程可用的最大连接数</code></div><div class="line number84 index83 alt1"><code class="bash spaces">&nbsp;&nbsp;&nbsp;</code><code class="bash plain">bind :80&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </code><code class="bash comments">#监听 80 端口</code></div><div class="line number85 index84 alt2"><code class="bash spaces">&nbsp;&nbsp;&nbsp;</code><code class="bash plain">log global&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </code></div><div class="line number86 index85 alt1"><code class="bash spaces">&nbsp;&nbsp;&nbsp;</code><code class="bash plain">option httplog&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </code></div><div class="line number87 index86 alt2"><code class="bash spaces">&nbsp;&nbsp;&nbsp;</code><code class="bash plain">option httpclose&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </code><code class="bash comments">#每次请求完毕后主动关闭 http 通道</code></div><div class="line number88 index87 alt1"><code class="bash spaces">&nbsp;&nbsp;&nbsp;</code><code class="bash plain">acl is_a hdr_beg(host) -i www.wangshibo.com&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </code><code class="bash comments">#规则设置，-i 后面是要访问的域名</code></div><div class="line number89 index88 alt2"><code class="bash spaces">&nbsp;&nbsp;&nbsp;</code><code class="bash plain">acl is_b hdr_beg(host) -i www.guohuihui.com&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </code><code class="bash comments">#如果多个域名，就写多个规则，一规则对应一个域名；即后面有多个域名，就写 is_c、 is-d….，这个名字可以随意起。但要与下面的use_backend 对应</code></div><div class="line number90 index89 alt1"><code class="bash spaces">&nbsp;&nbsp;&nbsp;</code><code class="bash plain">use_backend web-server </code><code class="bash keyword">if</code> <code class="bash plain">is_a&nbsp;&nbsp;&nbsp; </code><code class="bash comments">#如果访问 is_a 设置的域名，就负载均衡到下面backend 设置的对应 web-server 上。web-server所负载的域名要都部署到下面的web01和web02上。如果是不同的域名部署到不同的机器上，就定义不同的web-server。</code></div><div class="line number91 index90 alt2"><code class="bash spaces">&nbsp;&nbsp;&nbsp;</code><code class="bash plain">use_backend web-server </code><code class="bash keyword">if</code> <code class="bash plain">is_b</code></div><div class="line number92 index91 alt1">&nbsp;</div><div class="line number93 index92 alt2"><code class="bash plain">backend web-server</code></div><div class="line number94 index93 alt1"><code class="bash spaces">&nbsp;&nbsp;&nbsp;</code><code class="bash plain">mode http</code></div><div class="line number95 index94 alt2"><code class="bash spaces">&nbsp;&nbsp;&nbsp;</code><code class="bash plain">balance roundrobin&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </code><code class="bash comments">#设置负载均衡模式，source 保存 session 值，roundrobin 轮询模式</code></div><div class="line number96 index95 alt1"><code class="bash spaces">&nbsp;&nbsp;&nbsp;</code><code class="bash plain">cookie SERVERID insert indirect nocache</code></div><div class="line number97 index96 alt2"><code class="bash spaces">&nbsp;&nbsp;&nbsp;</code><code class="bash plain">option httpclose</code></div><div class="line number98 index97 alt1"><code class="bash spaces">&nbsp;&nbsp;&nbsp;</code><code class="bash plain">option forwardfor</code></div><div class="line number99 index98 alt2"><code class="bash spaces">&nbsp;&nbsp;&nbsp;</code><code class="bash plain">server web01 182.148.15.233:80 weight 1 cookie 3 check inter 2000 rise 2 fall 5</code></div><div class="line number100 index99 alt1"><code class="bash spaces">&nbsp;&nbsp;&nbsp;</code><code class="bash plain">server web02 182.148.15.238:80 weight 1 cookie 4 check inter 2000 rise 2 fall 5</code></div><div class="line number101 index100 alt2">&nbsp;</div><div class="line number102 index101 alt1"><code class="bash plain">注意参数解释：inter 2000 心跳检测时间；rise 2 三次连接成功，表示服务器正常；fall 5 三次连接失败，表示服务器异常； weight 1 权重设置</code></div><div class="line number103 index102 alt2">&nbsp;</div><div class="line number104 index103 alt1">&nbsp;</div><div class="line number105 index104 alt2"><code class="bash plain">3）启动haproxy（Haproxy_Keepalived_Master 和 Haproxy_Keepalived_Backup两台机器都要操作）</code></div><div class="line number106 index105 alt1"><code class="bash plain">[root@Haproxy_Keepalived_Master ~]</code><code class="bash comments"># service haproxy start&nbsp;&nbsp;&nbsp; #启动</code></div><div class="line number107 index106 alt2"><code class="bash plain">[root@Haproxy_Keepalived_Master ~]</code><code class="bash comments"># service haproxy stop&nbsp;&nbsp;&nbsp;&nbsp; #关闭</code></div><div class="line number108 index107 alt1"><code class="bash plain">[root@Haproxy_Keepalived_Master ~]</code><code class="bash comments"># service haproxy restart&nbsp; #重启</code></div><div class="line number109 index108 alt2"><code class="bash plain">[root@Haproxy_Keepalived_Master ~]</code><code class="bash comments"># service haproxy status&nbsp;&nbsp; #查看服务状态</code></div><div class="line number110 index109 alt1">&nbsp;</div><div class="line number111 index110 alt2"><code class="bash plain">4）设置HAProxy日志（Haproxy_Keepalived_Master 和 Haproxy_Keepalived_Backup两台机器都要操作）</code></div><div class="line number112 index111 alt1"><code class="bash plain">[root@Haproxy_Keepalived_Master ~]</code><code class="bash comments"># vim /etc/rsyslog.conf</code></div><div class="line number113 index112 alt2"><code class="bash plain">.......</code></div><div class="line number114 index113 alt1"><code class="bash plain">$ModLoad imudp&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </code><code class="bash comments">#取消注释 ，这一行不注释，日志就不会写</code></div><div class="line number115 index114 alt2"><code class="bash plain">$UDPServerRun 514&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </code><code class="bash comments">#取消注释 ，这一行不注释，日志就不会写</code></div><div class="line number116 index115 alt1"><code class="bash plain">.......</code></div><div class="line number117 index116 alt2"><code class="bash plain">local0.*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </code><code class="bash plain">/var/log/haproxy</code><code class="bash plain">.log&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </code><code class="bash comments">#这一行可以没有，可以不用写</code></div><div class="line number118 index117 alt1"><code class="bash plain">local3.*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </code><code class="bash plain">/var/log/haproxy</code><code class="bash plain">.log&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </code><code class="bash comments">#这一行必须要写</code></div><div class="line number119 index118 alt2">&nbsp;</div><div class="line number120 index119 alt1"><code class="bash plain">[root@Haproxy_Keepalived_Master ~]</code><code class="bash comments"># vim /etc/sysconfig/rsyslog</code></div><div class="line number121 index120 alt2"><code class="bash plain">SYSLOGD_OPTIONS=</code><code class="bash string">"-r -m 0"</code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <code class="bash comments">#接收远程服务器日志</code></div><div class="line number122 index121 alt1">&nbsp;</div><div class="line number123 index122 alt2"><code class="bash plain">[root@Haproxy_Keepalived_Master ~]</code><code class="bash comments"># service rsyslog restart</code></div><div class="line number124 index123 alt1">&nbsp;</div><div class="line number125 index124 alt2">&nbsp;</div><div class="line number126 index125 alt1"><code class="bash plain">-------------------------------------------------------------------------------------------------------------------------</code></div><div class="line number127 index126 alt2">&nbsp;</div><div class="line number128 index127 alt1"><code class="bash plain">1）安装Keepalived（Haproxy_Keepalived_Master 和 Haproxy_Keepalived_Backup两台机器都要操作）</code></div><div class="line number129 index128 alt2"><code class="bash plain">[root@Haproxy_keepalived_Master ~]</code><code class="bash comments"># yum install -y openssl-devel</code></div><div class="line number130 index129 alt1"><code class="bash plain">[root@Haproxy_keepalived_Master ~]</code><code class="bash comments"># cd /usr/local/src/</code></div><div class="line number131 index130 alt2"><code class="bash plain">[root@Haproxy_keepalived_Master src]</code><code class="bash comments"># wget http://www.keepalived.org/software/keepalived-1.3.5.tar.gz</code></div><div class="line number132 index131 alt1"><code class="bash plain">[root@Haproxy_keepalived_Master src]</code><code class="bash comments"># tar -zvxf keepalived-1.3.5.tar.gz</code></div><div class="line number133 index132 alt2"><code class="bash plain">[root@Haproxy_keepalived_Master src]</code><code class="bash comments"># cd keepalived-1.3.5</code></div><div class="line number134 index133 alt1"><code class="bash plain">[root@Haproxy_keepalived_Master keepalived-1.3.5]</code><code class="bash comments"># ./configure --prefix=/usr/local/keepalived</code></div><div class="line number135 index134 alt2"><code class="bash plain">[root@Haproxy_keepalived_Master keepalived-1.3.5]</code><code class="bash comments"># make &amp;&amp; make install</code></div><div class="line number136 index135 alt1"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code>&nbsp;</div><div class="line number137 index136 alt2"><code class="bash plain">[root@Haproxy_keepalived_Master keepalived-1.3.5]</code><code class="bash comments"># cp /usr/local/src/keepalived-1.3.5/keepalived/etc/init.d/keepalived /etc/rc.d/init.d/</code></div><div class="line number138 index137 alt1"><code class="bash plain">[root@Haproxy_keepalived_Master keepalived-1.3.5]</code><code class="bash comments"># cp /usr/local/keepalived/etc/sysconfig/keepalived /etc/sysconfig/</code></div><div class="line number139 index138 alt2"><code class="bash plain">[root@Haproxy_keepalived_Master keepalived-1.3.5]</code><code class="bash comments"># mkdir /etc/keepalived/</code></div><div class="line number140 index139 alt1"><code class="bash plain">[root@Haproxy_keepalived_Master keepalived-1.3.5]</code><code class="bash comments"># cp /usr/local/keepalived/etc/keepalived/keepalived.conf /etc/keepalived/</code></div><div class="line number141 index140 alt2"><code class="bash plain">[root@Haproxy_keepalived_Master keepalived-1.3.5]</code><code class="bash comments"># cp /usr/local/keepalived/sbin/keepalived /usr/sbin/</code></div><div class="line number142 index141 alt1"><code class="bash plain">[root@Haproxy_keepalived_Master keepalived-1.3.5]</code><code class="bash comments"># echo "/etc/init.d/keepalived start" &gt;&gt; /etc/rc.local</code></div><div class="line number143 index142 alt2">&nbsp;</div><div class="line number144 index143 alt1"><code class="bash plain">[root@Haproxy_keepalived_Master keepalived-1.3.5]</code><code class="bash comments"># chmod +x /etc/rc.d/init.d/keepalived&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; #添加执行权限</code></div><div class="line number145 index144 alt2"><code class="bash plain">[root@Haproxy_keepalived_Master keepalived-1.3.5]</code><code class="bash comments"># chkconfig keepalived on&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; #设置开机启动</code></div><div class="line number146 index145 alt1"><code class="bash plain">[root@Haproxy_keepalived_Master keepalived-1.3.5]</code><code class="bash comments"># service keepalived start&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; #启动</code></div><div class="line number147 index146 alt2"><code class="bash plain">[root@Haproxy_keepalived_Master keepalived-1.3.5]</code><code class="bash comments"># service keepalived stop&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; #关闭</code></div><div class="line number148 index147 alt1"><code class="bash plain">[root@Haproxy_keepalived_Master keepalived-1.3.5]</code><code class="bash comments"># service keepalived restart&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; #重启</code></div><div class="line number149 index148 alt2">&nbsp;</div><div class="line number150 index149 alt1"><code class="bash plain">2）Haproxy_Keepalived_Master服务器上的Keepalived配置如下：</code></div><div class="line number151 index150 alt2"><code class="bash plain">[root@Haproxy_Keepalived_Master ~]</code><code class="bash comments"># cp /etc/keepalived/keepalived.conf /etc/keepalived/keepalived.conf-bak</code></div><div class="line number152 index151 alt1"><code class="bash plain">[root@Haproxy_Keepalived_Master ~]</code><code class="bash comments"># vim /etc/keepalived/keepalived.conf</code></div><div class="line number153 index152 alt2"><code class="bash plain">! Configuration File </code><code class="bash keyword">for</code> <code class="bash plain">keepalived</code></div><div class="line number154 index153 alt1"><code class="bash plain">global_defs {</code></div><div class="line number155 index154 alt2"><code class="bash spaces">&nbsp;&nbsp;</code><code class="bash plain">notification_email {</code></div><div class="line number156 index155 alt1"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash plain">root@localhost</code></div><div class="line number157 index156 alt2"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash plain">}</code></div><div class="line number158 index157 alt1">&nbsp;</div><div class="line number159 index158 alt2"><code class="bash plain">notification_email_from keepalived@localhost</code></div><div class="line number160 index159 alt1"><code class="bash plain">smtp_server 127.0.0.1</code></div><div class="line number161 index160 alt2"><code class="bash plain">smtp_connect_timeout 30</code></div><div class="line number162 index161 alt1"><code class="bash plain">router_id HAproxy237</code></div><div class="line number163 index162 alt2"><code class="bash plain">}</code></div><div class="line number164 index163 alt1">&nbsp;</div><div class="line number165 index164 alt2"><code class="bash plain">vrrp_script chk_haproxy {&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </code><code class="bash comments">#HAproxy 服务监控脚本&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </code></div><div class="line number166 index165 alt1"><code class="bash spaces">&nbsp;&nbsp;</code><code class="bash plain">script </code><code class="bash string">"/etc/keepalived/check_haproxy.sh"</code></div><div class="line number167 index166 alt2"><code class="bash spaces">&nbsp;&nbsp;</code><code class="bash plain">interval 2</code></div><div class="line number168 index167 alt1"><code class="bash spaces">&nbsp;&nbsp;</code><code class="bash plain">weight 2</code></div><div class="line number169 index168 alt2"><code class="bash plain">}</code></div><div class="line number170 index169 alt1">&nbsp;</div><div class="line number171 index170 alt2"><code class="bash plain">vrrp_instance VI_1 { </code></div><div class="line number172 index171 alt1"><code class="bash spaces">&nbsp;&nbsp;</code><code class="bash plain">state MASTER </code></div><div class="line number173 index172 alt2"><code class="bash spaces">&nbsp;&nbsp;</code><code class="bash plain">interface eth0</code></div><div class="line number174 index173 alt1"><code class="bash spaces">&nbsp;&nbsp;</code><code class="bash plain">virtual_router_id 51</code></div><div class="line number175 index174 alt2"><code class="bash spaces">&nbsp;&nbsp;</code><code class="bash plain">priority 100</code></div><div class="line number176 index175 alt1"><code class="bash spaces">&nbsp;&nbsp;</code><code class="bash plain">advert_int 1</code></div><div class="line number177 index176 alt2"><code class="bash spaces">&nbsp;&nbsp;</code><code class="bash plain">authentication {</code></div><div class="line number178 index177 alt1"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash plain">auth_type PASS</code></div><div class="line number179 index178 alt2"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash plain">auth_pass 1111</code></div><div class="line number180 index179 alt1"><code class="bash plain">}</code></div><div class="line number181 index180 alt2"><code class="bash spaces">&nbsp;&nbsp;</code><code class="bash plain">track_script {</code></div><div class="line number182 index181 alt1"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash plain">chk_haproxy </code></div><div class="line number183 index182 alt2"><code class="bash plain">}</code></div><div class="line number184 index183 alt1"><code class="bash plain">virtual_ipaddress {</code></div><div class="line number185 index184 alt2"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash plain">182.148.15.239 </code></div><div class="line number186 index185 alt1"><code class="bash plain">}</code></div><div class="line number187 index186 alt2"><code class="bash plain">notify_master </code><code class="bash string">"/etc/keepalived/clean_arp.sh 182.148.15.239"</code></div><div class="line number188 index187 alt1"><code class="bash plain">}</code></div><div class="line number189 index188 alt2"><code class="bash plain">vrrp_instance VI_2 {</code></div><div class="line number190 index189 alt1"><code class="bash spaces">&nbsp;&nbsp;</code><code class="bash plain">state BACKUP</code></div><div class="line number191 index190 alt2"><code class="bash spaces">&nbsp;&nbsp;</code><code class="bash plain">interface eth0</code></div><div class="line number192 index191 alt1"><code class="bash spaces">&nbsp;&nbsp;</code><code class="bash plain">virtual_router_id 52</code></div><div class="line number193 index192 alt2"><code class="bash spaces">&nbsp;&nbsp;</code><code class="bash plain">priority 99</code></div><div class="line number194 index193 alt1"><code class="bash spaces">&nbsp;&nbsp;</code><code class="bash plain">advert_int 1</code></div><div class="line number195 index194 alt2"><code class="bash spaces">&nbsp;&nbsp;</code><code class="bash plain">authentication {</code></div><div class="line number196 index195 alt1"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash plain">auth_type PASS</code></div><div class="line number197 index196 alt2"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash plain">auth_pass 1111</code></div><div class="line number198 index197 alt1"><code class="bash plain">}</code></div><div class="line number199 index198 alt2"><code class="bash plain">virtual_ipaddress {</code></div><div class="line number200 index199 alt1"><code class="bash spaces">&nbsp;&nbsp;</code><code class="bash plain">182.148.15.235</code></div><div class="line number201 index200 alt2"><code class="bash plain">}</code></div><div class="line number202 index201 alt1"><code class="bash plain">notify_master </code><code class="bash string">"/etc/keepalived/clean_arp.sh 182.148.15.235"</code></div><div class="line number203 index202 alt2"><code class="bash plain">}</code></div><div class="line number204 index203 alt1">&nbsp;</div><div class="line number205 index204 alt2">&nbsp;</div><div class="line number206 index205 alt1"><code class="bash plain">3）Haproxy_Keepalived_Backup服务器上的Keepalived配置如下：</code></div><div class="line number207 index206 alt2"><code class="bash plain">[root@Haproxy_Keepalived_Backup ~]</code><code class="bash comments"># /etc/keepalived/keepalived.conf /etc/keepalived/keepalived.conf-bak</code></div><div class="line number208 index207 alt1"><code class="bash plain">[root@Haproxy_Keepalived_Backup ~]</code><code class="bash comments"># vim /etc/keepalived/keepalived.conf</code></div><div class="line number209 index208 alt2"><code class="bash plain">! Configuration File </code><code class="bash keyword">for</code> <code class="bash plain">keepalived</code></div><div class="line number210 index209 alt1"><code class="bash plain">global_defs {</code></div><div class="line number211 index210 alt2"><code class="bash spaces">&nbsp;&nbsp;</code><code class="bash plain">notification_email {</code></div><div class="line number212 index211 alt1"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash plain">root@localhost</code></div><div class="line number213 index212 alt2"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash plain">}</code></div><div class="line number214 index213 alt1">&nbsp;</div><div class="line number215 index214 alt2"><code class="bash plain">notification_email_from keepalived@localhost</code></div><div class="line number216 index215 alt1"><code class="bash plain">smtp_server 127.0.0.1</code></div><div class="line number217 index216 alt2"><code class="bash plain">smtp_connect_timeout 30</code></div><div class="line number218 index217 alt1"><code class="bash plain">router_id HAproxy236</code></div><div class="line number219 index218 alt2"><code class="bash plain">}</code></div><div class="line number220 index219 alt1">&nbsp;</div><div class="line number221 index220 alt2"><code class="bash plain">vrrp_script chk_haproxy {&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </code></div><div class="line number222 index221 alt1"><code class="bash spaces">&nbsp;&nbsp;</code><code class="bash plain">script </code><code class="bash string">"/etc/keepalived/check_haproxy.sh"</code></div><div class="line number223 index222 alt2"><code class="bash spaces">&nbsp;&nbsp;</code><code class="bash plain">interval 2</code></div><div class="line number224 index223 alt1"><code class="bash spaces">&nbsp;&nbsp;</code><code class="bash plain">weight 2</code></div><div class="line number225 index224 alt2"><code class="bash plain">}</code></div><div class="line number226 index225 alt1">&nbsp;</div><div class="line number227 index226 alt2"><code class="bash plain">vrrp_instance VI_1 { </code></div><div class="line number228 index227 alt1"><code class="bash spaces">&nbsp;&nbsp;</code><code class="bash plain">state BACKUP</code></div><div class="line number229 index228 alt2"><code class="bash spaces">&nbsp;&nbsp;</code><code class="bash plain">interface eth0</code></div><div class="line number230 index229 alt1"><code class="bash spaces">&nbsp;&nbsp;</code><code class="bash plain">virtual_router_id 51</code></div><div class="line number231 index230 alt2"><code class="bash spaces">&nbsp;&nbsp;</code><code class="bash plain">priority 99</code></div><div class="line number232 index231 alt1"><code class="bash spaces">&nbsp;&nbsp;</code><code class="bash plain">advert_int 1</code></div><div class="line number233 index232 alt2"><code class="bash spaces">&nbsp;&nbsp;</code><code class="bash plain">authentication {</code></div><div class="line number234 index233 alt1"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash plain">auth_type PASS</code></div><div class="line number235 index234 alt2"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash plain">auth_pass 1111</code></div><div class="line number236 index235 alt1"><code class="bash plain">}</code></div><div class="line number237 index236 alt2"><code class="bash spaces">&nbsp;&nbsp;</code><code class="bash plain">track_script {</code></div><div class="line number238 index237 alt1"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash plain">chk_haproxy </code></div><div class="line number239 index238 alt2"><code class="bash plain">}</code></div><div class="line number240 index239 alt1"><code class="bash plain">virtual_ipaddress {</code></div><div class="line number241 index240 alt2"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash plain">182.148.15.239</code></div><div class="line number242 index241 alt1"><code class="bash plain">}</code></div><div class="line number243 index242 alt2"><code class="bash plain">notify_master </code><code class="bash string">"/etc/keepalived/clean_arp.sh 182.148.15.239"</code></div><div class="line number244 index243 alt1"><code class="bash plain">}</code></div><div class="line number245 index244 alt2"><code class="bash plain">vrrp_instance VI_2 {</code></div><div class="line number246 index245 alt1"><code class="bash spaces">&nbsp;&nbsp;</code><code class="bash plain">state MASTER</code></div><div class="line number247 index246 alt2"><code class="bash spaces">&nbsp;&nbsp;</code><code class="bash plain">interface eth0</code></div><div class="line number248 index247 alt1"><code class="bash spaces">&nbsp;&nbsp;</code><code class="bash plain">virtual_router_id 52</code></div><div class="line number249 index248 alt2"><code class="bash spaces">&nbsp;&nbsp;</code><code class="bash plain">priority 100</code></div><div class="line number250 index249 alt1"><code class="bash spaces">&nbsp;&nbsp;</code><code class="bash plain">advert_int 1</code></div><div class="line number251 index250 alt2"><code class="bash spaces">&nbsp;&nbsp;</code><code class="bash plain">authentication {</code></div><div class="line number252 index251 alt1"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash plain">auth_type PASS</code></div><div class="line number253 index252 alt2"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash plain">auth_pass 1111</code></div><div class="line number254 index253 alt1"><code class="bash plain">}</code></div><div class="line number255 index254 alt2"><code class="bash plain">virtual_ipaddress {</code></div><div class="line number256 index255 alt1"><code class="bash spaces">&nbsp;&nbsp;</code><code class="bash plain">182.148.15.235</code></div><div class="line number257 index256 alt2"><code class="bash plain">}</code></div><div class="line number258 index257 alt1"><code class="bash plain">notify_master </code><code class="bash string">"/etc/keepalived/clean_arp.sh 182.148.15.235"</code></div><div class="line number259 index258 alt2"><code class="bash plain">}</code></div><div class="line number260 index259 alt1">&nbsp;</div><div class="line number261 index260 alt2"><code class="bash plain">4）设置HAproxy服务监控脚本（Haproxy_Keepalived_Master 和 Haproxy_Keepalived_Backup两台机器都要操作）</code></div><div class="line number262 index261 alt1"><code class="bash plain">[root@Haproxy_Keepalived_Master ~]</code><code class="bash comments"># vim /etc/keepalived/check_haproxy.sh</code></div><div class="line number263 index262 alt2"><code class="bash preprocessor bold">#!/bin/bash</code></div><div class="line number264 index263 alt1"><code class="bash plain">A=`</code><code class="bash functions">ps</code> <code class="bash plain">-C haproxy --no-header | </code><code class="bash functions">wc</code> <code class="bash plain">-l`</code></div><div class="line number265 index264 alt2"><code class="bash keyword">if</code> <code class="bash plain">[ $A -</code><code class="bash keyword">eq</code> <code class="bash plain">0 ];</code><code class="bash keyword">then</code></div><div class="line number266 index265 alt1"><code class="bash plain">/etc/init</code><code class="bash plain">.d</code><code class="bash plain">/haproxy</code> <code class="bash plain">start</code></div><div class="line number267 index266 alt2"><code class="bash functions">sleep</code> <code class="bash plain">3</code></div><div class="line number268 index267 alt1"><code class="bash keyword">if</code> <code class="bash plain">[ `</code><code class="bash functions">ps</code> <code class="bash plain">-C haproxy --no-header | </code><code class="bash functions">wc</code> <code class="bash plain">-l ` -</code><code class="bash keyword">eq</code> <code class="bash plain">0 ];</code><code class="bash keyword">then</code></div><div class="line number269 index268 alt2"><code class="bash plain">/etc/init</code><code class="bash plain">.d</code><code class="bash plain">/keepalived</code> <code class="bash plain">stop</code></div><div class="line number270 index269 alt1"><code class="bash keyword">fi</code></div><div class="line number271 index270 alt2"><code class="bash keyword">fi</code></div><div class="line number272 index271 alt1">&nbsp;</div><div class="line number273 index272 alt2"><code class="bash plain">[root@Haproxy_Keepalived_Master ~]</code><code class="bash comments"># chmod +x /etc/keepalived/check_haproxy.sh</code></div><div class="line number274 index273 alt1">&nbsp;</div><div class="line number275 index274 alt2"><code class="bash plain">5）设置更新虚拟服务器（VIP）地址的arp记录到网关脚本（Haproxy_Keepalived_Master 和 Haproxy_Keepalived_Backup两台机器都要操作）</code></div><div class="line number276 index275 alt1"><code class="bash plain">[root@Haproxy_Keepalived_Master ~]</code><code class="bash comments"># vim /etc/keepalived/clean_arp.sh</code></div><div class="line number277 index276 alt2"><code class="bash preprocessor bold">#!/bin/sh</code></div><div class="line number278 index277 alt1"><code class="bash plain">VIP=$1</code></div><div class="line number279 index278 alt2"><code class="bash plain">GATEWAY=182.148.15.254&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </code><code class="bash comments">#这个是本机的外网网卡网关地址</code></div><div class="line number280 index279 alt1"><code class="bash plain">/sbin/arping</code> <code class="bash plain">-I eth0 -c 5 -s $VIP $GATEWAY &amp;&gt;</code><code class="bash plain">/dev/null</code></div><div class="line number281 index280 alt2">&nbsp;</div><div class="line number282 index281 alt1"><code class="bash plain">6）系统内核优化（Haproxy_Keepalived_Master 和 Haproxy_Keepalived_Backup两台机器都要操作）</code></div><div class="line number283 index282 alt2"><code class="bash plain">[root@Haproxy_Keepalived_Master ~]</code><code class="bash comments"># echo 1024 60999 &gt; /proc/sys/net/ipv4/ip_local_port_range</code></div><div class="line number284 index283 alt1"><code class="bash plain">[root@Haproxy_Keepalived_Master ~]</code><code class="bash comments"># echo 30 &gt; /proc/sys/net/ipv4/tcp_fin_timeout</code></div><div class="line number285 index284 alt2"><code class="bash plain">[root@Haproxy_Keepalived_Master ~]</code><code class="bash comments"># echo 4096 &gt; /proc/sys/net/ipv4/tcp_max_syn_backlog</code></div><div class="line number286 index285 alt1"><code class="bash plain">[root@Haproxy_Keepalived_Master ~]</code><code class="bash comments"># echo 262144 &gt; /proc/sys/net/ipv4/tcp_max_tw_buckets</code></div><div class="line number287 index286 alt2"><code class="bash plain">[root@Haproxy_Keepalived_Master ~]</code><code class="bash comments"># echo 262144 &gt; /proc/sys/net/ipv4/tcp_max_orphans</code></div><div class="line number288 index287 alt1"><code class="bash plain">[root@Haproxy_Keepalived_Master ~]</code><code class="bash comments"># echo 300 &gt; /proc/sys/net/ipv4/tcp_keepalive_time</code></div><div class="line number289 index288 alt2"><code class="bash plain">[root@Haproxy_Keepalived_Master ~]</code><code class="bash comments"># echo 1 &gt; /proc/sys/net/ipv4/tcp_tw_recycle</code></div><div class="line number290 index289 alt1"><code class="bash plain">[root@Haproxy_Keepalived_Master ~]</code><code class="bash comments"># echo 0 &gt; /proc/sys/net/ipv4/tcp_timestamps</code></div><div class="line number291 index290 alt2"><code class="bash plain">[root@Haproxy_Keepalived_Master ~]</code><code class="bash comments"># echo 0 &gt; /proc/sys/net/ipv4/tcp_ecn</code></div><div class="line number292 index291 alt1"><code class="bash plain">[root@Haproxy_Keepalived_Master ~]</code><code class="bash comments"># echo 1 &gt; /proc/sys/net/ipv4/tcp_sack</code></div><div class="line number293 index292 alt2"><code class="bash plain">[root@Haproxy_Keepalived_Master ~]</code><code class="bash comments"># echo 0 &gt; /proc/sys/net/ipv4/tcp_dsack</code></div><div class="line number294 index293 alt1">&nbsp;</div><div class="line number295 index294 alt2"><code class="bash plain">7）分别启动Haproxy_Keepalived_Master 和 Haproxy_Keepalived_Backup的keealived和haproxy服务，并查看vip</code></div><div class="line number296 index295 alt1"><code class="bash plain">[root@Haproxy_Keepalived_Master ~]</code><code class="bash comments"># /etc/init.d/keepalived start</code></div><div class="line number297 index296 alt2"><code class="bash plain">[root@Haproxy_Keepalived_Master ~]</code><code class="bash comments"># /etc/init.d/haproxy start</code></div><div class="line number298 index297 alt1"><code class="bash plain">[root@Haproxy_Keepalived_Master ~]</code><code class="bash comments"># ip addr&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </code></div><div class="line number299 index298 alt2"><code class="bash plain">1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN </code></div><div class="line number300 index299 alt1"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash plain">link</code><code class="bash plain">/loopback</code> <code class="bash plain">00:00:00:00:00:00 brd 00:00:00:00:00:00</code></div><div class="line number301 index300 alt2"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash plain">inet 127.0.0.1</code><code class="bash plain">/8</code> <code class="bash plain">scope host lo</code></div><div class="line number302 index301 alt1"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash plain">inet6 ::1</code><code class="bash plain">/128</code> <code class="bash plain">scope host </code></div><div class="line number303 index302 alt2"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash plain">valid_lft forever preferred_lft forever</code></div><div class="line number304 index303 alt1"><code class="bash plain">2: eth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc pfifo_fast state UP qlen 1000</code></div><div class="line number305 index304 alt2"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash plain">link</code><code class="bash plain">/ether</code> <code class="bash plain">52:54:00:68:</code><code class="bash functions">dc</code><code class="bash plain">:b6 brd ff:ff:ff:ff:ff:ff</code></div><div class="line number306 index305 alt1"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash plain">inet 182.148.15.237</code><code class="bash plain">/27</code> <code class="bash plain">brd 182.148.15.255 scope global eth0</code></div><div class="line number307 index306 alt2"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash plain">inet 182.148.15.239</code><code class="bash plain">/32</code> <code class="bash plain">scope global eth0</code></div><div class="line number308 index307 alt1"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash plain">inet6 fe80::5054:ff:fe68:dcb6</code><code class="bash plain">/64</code> <code class="bash plain">scope link </code></div><div class="line number309 index308 alt2"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash plain">valid_lft forever preferred_lft forever</code></div><div class="line number310 index309 alt1">&nbsp;</div><div class="line number311 index310 alt2"><code class="bash plain">[root@Haproxy_Keepalived_Backup ~]</code><code class="bash comments"># /etc/init.d/keepalived start</code></div><div class="line number312 index311 alt1"><code class="bash plain">[root@Haproxy_Keepalived_Backup ~]</code><code class="bash comments"># /etc/init.d/haproxy start</code></div><div class="line number313 index312 alt2"><code class="bash plain">[root@Haproxy_Keepalived_Backup ~]</code><code class="bash comments"># ip addr</code></div><div class="line number314 index313 alt1"><code class="bash plain">1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN </code></div><div class="line number315 index314 alt2"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash plain">link</code><code class="bash plain">/loopback</code> <code class="bash plain">00:00:00:00:00:00 brd 00:00:00:00:00:00</code></div><div class="line number316 index315 alt1"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash plain">inet 127.0.0.1</code><code class="bash plain">/8</code> <code class="bash plain">scope host lo</code></div><div class="line number317 index316 alt2"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash plain">inet6 ::1</code><code class="bash plain">/128</code> <code class="bash plain">scope host </code></div><div class="line number318 index317 alt1"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash plain">valid_lft forever preferred_lft forever</code></div><div class="line number319 index318 alt2"><code class="bash plain">2: eth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc pfifo_fast state UP qlen 1000</code></div><div class="line number320 index319 alt1"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash plain">link</code><code class="bash plain">/ether</code> <code class="bash plain">52:54:00:7c:b8:f0 brd ff:ff:ff:ff:ff:ff</code></div><div class="line number321 index320 alt2"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash plain">inet 182.148.15.236</code><code class="bash plain">/27</code> <code class="bash plain">brd 182.148.15.255 scope global eth0</code></div><div class="line number322 index321 alt1"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash plain">inet 182.148.15.235</code><code class="bash plain">/32</code> <code class="bash plain">scope global eth0</code></div><div class="line number323 index322 alt2"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash plain">inet6 fe80::5054:ff:fe7c:b8f0</code><code class="bash plain">/64</code> <code class="bash plain">scope link </code></div><div class="line number324 index323 alt1"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash plain">valid_lft forever preferred_lft forever</code></div></div></td></tr></tbody></table></div></div>
</div>
<p><span style="color: #ff00ff;"><strong>3）两台Real Server上的操作</strong></span></p>
<div class="cnblogs_Highlighter sh-gutter">
<div><div id="highlighter_248564" class="syntaxhighlighter  bash"><div class="toolbar"><span><a href="#" class="toolbar_item command_help help">?</a></span></div><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div><div class="line number3 index2 alt2">3</div><div class="line number4 index3 alt1">4</div><div class="line number5 index4 alt2">5</div><div class="line number6 index5 alt1">6</div><div class="line number7 index6 alt2">7</div><div class="line number8 index7 alt1">8</div><div class="line number9 index8 alt2">9</div><div class="line number10 index9 alt1">10</div><div class="line number11 index10 alt2">11</div><div class="line number12 index11 alt1">12</div><div class="line number13 index12 alt2">13</div><div class="line number14 index13 alt1">14</div><div class="line number15 index14 alt2">15</div><div class="line number16 index15 alt1">16</div><div class="line number17 index16 alt2">17</div><div class="line number18 index17 alt1">18</div><div class="line number19 index18 alt2">19</div><div class="line number20 index19 alt1">20</div><div class="line number21 index20 alt2">21</div><div class="line number22 index21 alt1">22</div><div class="line number23 index22 alt2">23</div><div class="line number24 index23 alt1">24</div><div class="line number25 index24 alt2">25</div><div class="line number26 index25 alt1">26</div><div class="line number27 index26 alt2">27</div><div class="line number28 index27 alt1">28</div><div class="line number29 index28 alt2">29</div><div class="line number30 index29 alt1">30</div><div class="line number31 index30 alt2">31</div><div class="line number32 index31 alt1">32</div><div class="line number33 index32 alt2">33</div><div class="line number34 index33 alt1">34</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="bash plain">在两台Real Server上配置好nginx，nginx安装配置过程省略。</code></div><div class="line number2 index1 alt1"><code class="bash spaces">&nbsp;</code>&nbsp;</div><div class="line number3 index2 alt2"><code class="bash plain">分别在两台Real Server上配置两个域名www.wangshibo.com和www.guohuihui.com</code></div><div class="line number4 index3 alt1">&nbsp;</div><div class="line number5 index4 alt2"><code class="bash plain">在Haproxy_Keepalived_Master 和 Haproxy_Keepalived_Backup两台机器上要能正常访问这两个域名</code></div><div class="line number6 index5 alt1"><code class="bash plain">[root@Haproxy_Keepalived_Master ~]</code><code class="bash comments"># curl http://www.wangshibo.com</code></div><div class="line number7 index6 alt2"><code class="bash plain">this is page of Real_Server1:182.148.15.238 www.wangshibo.com</code></div><div class="line number8 index7 alt1"><code class="bash plain">[root@Haproxy_Keepalived_Master ~]</code><code class="bash comments"># curl http://www.guohuihui.com</code></div><div class="line number9 index8 alt2"><code class="bash plain">this is page of Real_Server2:182.148.15.238 www.guohuihui.com</code></div><div class="line number10 index9 alt1">&nbsp;</div><div class="line number11 index10 alt2"><code class="bash plain">[root@Haproxy_Keepalived_Backup ~]</code><code class="bash comments"># curl http://www.wangshibo.com</code></div><div class="line number12 index11 alt1"><code class="bash plain">this is page of Real_Server1:182.148.15.238 www.wangshibo.com</code></div><div class="line number13 index12 alt2"><code class="bash plain">[root@Haproxy_Keepalived_Backup ~]</code><code class="bash comments"># curl http://www.guohuihui.com</code></div><div class="line number14 index13 alt1"><code class="bash plain">this is page of Real_Server2:182.148.15.238 www.guohuihui.com</code></div><div class="line number15 index14 alt2">&nbsp;</div><div class="line number16 index15 alt1"><code class="bash plain">关闭182.148.15.238这台机器（即Real_Server2）的nginx，发现对于域名的请求就会到Real_Server1上</code></div><div class="line number17 index16 alt2"><code class="bash plain">[root@Real_Server2 ~]</code><code class="bash comments"># /usr/local/nginx/sbin/nginx -s stop</code></div><div class="line number18 index17 alt1"><code class="bash plain">[root@Real_Server2 ~]</code><code class="bash comments"># lsof -i:80</code></div><div class="line number19 index18 alt2">&nbsp;</div><div class="line number20 index19 alt1"><code class="bash plain">[root@Haproxy_Keepalived_Master ~]</code><code class="bash comments"># curl http://www.wangshibo.com</code></div><div class="line number21 index20 alt2"><code class="bash plain">this is page of Real_Server1:182.148.15.233 www.wangshibo.com</code></div><div class="line number22 index21 alt1"><code class="bash plain">[root@Haproxy_Keepalived_Master ~]</code><code class="bash comments"># curl http://www.guohuihui.com</code></div><div class="line number23 index22 alt2"><code class="bash plain">this is page of Real_Server1:182.148.15.233 www.guohuihui.com</code></div><div class="line number24 index23 alt1"><code class="bash plain">[root@Haproxy_Keepalived_Backup ~]</code><code class="bash comments"># curl http://www.wangshibo.com</code></div><div class="line number25 index24 alt2"><code class="bash plain">this is page of Real_Server1:182.148.15.233 www.wangshibo.com</code></div><div class="line number26 index25 alt1"><code class="bash plain">[root@Haproxy_Keepalived_Backup ~]</code><code class="bash comments"># curl http://www.guohuihui.com</code></div><div class="line number27 index26 alt2"><code class="bash plain">this is page of Real_Server1:182.148.15.233 www.guohuihui.com</code></div><div class="line number28 index27 alt1">&nbsp;</div><div class="line number29 index28 alt2"><code class="bash plain">另外，设置这两台Real Server的iptables，让其80端口只对前面的两个vip资源开放</code></div><div class="line number30 index29 alt1"><code class="bash plain">[root@Real_Server1 ~]</code><code class="bash comments"># vim /etc/sysconfig/iptables</code></div><div class="line number31 index30 alt2"><code class="bash plain">......</code></div><div class="line number32 index31 alt1"><code class="bash plain">-A INPUT -s 182.148.15.235 -m state --state NEW -m tcp -p tcp --dport 80 -j ACCEPT</code></div><div class="line number33 index32 alt2"><code class="bash plain">-A INPUT -s 182.148.15.239 -m state --state NEW -m tcp -p tcp --dport 80 -j ACCEPT</code></div><div class="line number34 index33 alt1"><code class="bash plain">[root@Real_Server1 ~]</code><code class="bash comments"># /etc/init.d/iptables restart</code></div></div></td></tr></tbody></table></div></div>
</div>
<p><span style="color: #ff00ff;"><strong>4）测试 HAProxy+Keepalived 是否正常运行</strong></span><br>将www.wangshibo.com和www.guohuihui.com域名解析到这两个VIP资源上<br>打开 HAProxy 监控页面。输入在haproxy.cfg文件里配置的用户名和密码<span style="color: #008000;">（如上，即用户名admin和密码dxInCtFianKtL]36）</span></p>
<p><img src="https://images2015.cnblogs.com/blog/907596/201705/907596-20170505161440929-1944915583.png" alt=""></p>
<p>&nbsp;</p>
<p>&nbsp;<img src="https://images2015.cnblogs.com/blog/907596/201705/907596-20170505161534601-315866555.png" alt=""></p>
<p><img src="https://images2015.cnblogs.com/blog/907596/201705/907596-20170505161545257-469278865.png" alt=""></p>
<p>可以看出后端两台Real Server服务器的web状态，如上截图，发现web01状态是ok的，web02状态是down，即Real_Server2这台服务器的nginx进程关闭，它已不在负载均衡内。<br>启动web02的nginx，再次查看，就在负载均衡内了</p>
<div class="cnblogs_Highlighter sh-gutter">
<div><div id="highlighter_806529" class="syntaxhighlighter  bash"><div class="toolbar"><span><a href="#" class="toolbar_item command_help help">?</a></span></div><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="bash plain">[root@Real_Server2 ~]</code><code class="bash comments"># /usr/local/nginx/sbin/nginx </code></div></div></td></tr></tbody></table></div></div>
</div>
<p><img src="https://images2015.cnblogs.com/blog/907596/201705/907596-20170505161944304-1613160852.png" alt=""></p>
<p>&nbsp;在浏览器里访问这两个域名，是可以正常访问的，如下访问请求负载到Real Server1（即182.148.15.233这台机器上）</p>
<p><img src="https://images2015.cnblogs.com/blog/907596/201705/907596-20170505162216007-2027559497.png" alt=""></p>
<p>&nbsp;</p>
<p><img src="https://images2015.cnblogs.com/blog/907596/201705/907596-20170505162206773-985130617.png" alt=""></p>
<p>尝试关闭Real Server1的nginx，再次访问这两个域名，发现访问请求就会负载到另一台Real Server2机器上了</p>
<div class="cnblogs_Highlighter sh-gutter">
<div><div id="highlighter_641171" class="syntaxhighlighter  bash"><div class="toolbar"><span><a href="#" class="toolbar_item command_help help">?</a></span></div><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="bash plain">[root@Real_Server1 ~]</code><code class="bash comments"># /usr/local/nginx/sbin/nginx -s stop</code></div></div></td></tr></tbody></table></div></div>
</div>
<p><img src="https://images2015.cnblogs.com/blog/907596/201705/907596-20170505162338070-1164777998.png" alt=""></p>
<p><img src="https://images2015.cnblogs.com/blog/907596/201705/907596-20170505162342976-319974774.png" alt=""></p>
<div class="cnblogs_Highlighter sh-gutter">
<div><div id="highlighter_65214" class="syntaxhighlighter  bash"><div class="toolbar"><span><a href="#" class="toolbar_item command_help help">?</a></span></div><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div><div class="line number3 index2 alt2">3</div><div class="line number4 index3 alt1">4</div><div class="line number5 index4 alt2">5</div><div class="line number6 index5 alt1">6</div><div class="line number7 index6 alt2">7</div><div class="line number8 index7 alt1">8</div><div class="line number9 index8 alt2">9</div><div class="line number10 index9 alt1">10</div><div class="line number11 index10 alt2">11</div><div class="line number12 index11 alt1">12</div><div class="line number13 index12 alt2">13</div><div class="line number14 index13 alt1">14</div><div class="line number15 index14 alt2">15</div><div class="line number16 index15 alt1">16</div><div class="line number17 index16 alt2">17</div><div class="line number18 index17 alt1">18</div><div class="line number19 index18 alt2">19</div><div class="line number20 index19 alt1">20</div><div class="line number21 index20 alt2">21</div><div class="line number22 index21 alt1">22</div><div class="line number23 index22 alt2">23</div><div class="line number24 index23 alt1">24</div><div class="line number25 index24 alt2">25</div><div class="line number26 index25 alt1">26</div><div class="line number27 index26 alt2">27</div><div class="line number28 index27 alt1">28</div><div class="line number29 index28 alt2">29</div><div class="line number30 index29 alt1">30</div><div class="line number31 index30 alt2">31</div><div class="line number32 index31 alt1">32</div><div class="line number33 index32 alt2">33</div><div class="line number34 index33 alt1">34</div><div class="line number35 index34 alt2">35</div><div class="line number36 index35 alt1">36</div><div class="line number37 index36 alt2">37</div><div class="line number38 index37 alt1">38</div><div class="line number39 index38 alt2">39</div><div class="line number40 index39 alt1">40</div><div class="line number41 index40 alt2">41</div><div class="line number42 index41 alt1">42</div><div class="line number43 index42 alt2">43</div><div class="line number44 index43 alt1">44</div><div class="line number45 index44 alt2">45</div><div class="line number46 index45 alt1">46</div><div class="line number47 index46 alt2">47</div><div class="line number48 index47 alt1">48</div><div class="line number49 index48 alt2">49</div><div class="line number50 index49 alt1">50</div><div class="line number51 index50 alt2">51</div><div class="line number52 index51 alt1">52</div><div class="line number53 index52 alt2">53</div><div class="line number54 index53 alt1">54</div><div class="line number55 index54 alt2">55</div><div class="line number56 index55 alt1">56</div><div class="line number57 index56 alt2">57</div><div class="line number58 index57 alt1">58</div><div class="line number59 index58 alt2">59</div><div class="line number60 index59 alt1">60</div><div class="line number61 index60 alt2">61</div><div class="line number62 index61 alt1">62</div><div class="line number63 index62 alt2">63</div><div class="line number64 index63 alt1">64</div><div class="line number65 index64 alt2">65</div><div class="line number66 index65 alt1">66</div><div class="line number67 index66 alt2">67</div><div class="line number68 index67 alt1">68</div><div class="line number69 index68 alt2">69</div><div class="line number70 index69 alt1">70</div><div class="line number71 index70 alt2">71</div><div class="line number72 index71 alt1">72</div><div class="line number73 index72 alt2">73</div><div class="line number74 index73 alt1">74</div><div class="line number75 index74 alt2">75</div><div class="line number76 index75 alt1">76</div><div class="line number77 index76 alt2">77</div><div class="line number78 index77 alt1">78</div><div class="line number79 index78 alt2">79</div><div class="line number80 index79 alt1">80</div><div class="line number81 index80 alt2">81</div><div class="line number82 index81 alt1">82</div><div class="line number83 index82 alt2">83</div><div class="line number84 index83 alt1">84</div><div class="line number85 index84 alt2">85</div><div class="line number86 index85 alt1">86</div><div class="line number87 index86 alt2">87</div><div class="line number88 index87 alt1">88</div><div class="line number89 index88 alt2">89</div><div class="line number90 index89 alt1">90</div><div class="line number91 index90 alt2">91</div><div class="line number92 index91 alt1">92</div><div class="line number93 index92 alt2">93</div><div class="line number94 index93 alt1">94</div><div class="line number95 index94 alt2">95</div><div class="line number96 index95 alt1">96</div><div class="line number97 index96 alt2">97</div><div class="line number98 index97 alt1">98</div><div class="line number99 index98 alt2">99</div><div class="line number100 index99 alt1">100</div><div class="line number101 index100 alt2">101</div><div class="line number102 index101 alt1">102</div><div class="line number103 index102 alt2">103</div><div class="line number104 index103 alt1">104</div><div class="line number105 index104 alt2">105</div><div class="line number106 index105 alt1">106</div><div class="line number107 index106 alt2">107</div><div class="line number108 index107 alt1">108</div><div class="line number109 index108 alt2">109</div><div class="line number110 index109 alt1">110</div><div class="line number111 index110 alt2">111</div><div class="line number112 index111 alt1">112</div><div class="line number113 index112 alt2">113</div><div class="line number114 index113 alt1">114</div><div class="line number115 index114 alt2">115</div><div class="line number116 index115 alt1">116</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="bash plain">接着测试Keepalived心跳测试的高可用</code></div><div class="line number2 index1 alt1"><code class="bash plain">默认情况下，Haproxy_Keepalived_Master 和Haproxy_Keepalived_Backup 这两台机器各自绑定自己的vip，并都提供服务。使用ip addr可以查看到VIP情况</code></div><div class="line number3 index2 alt2"><code class="bash plain">[root@Haproxy_Keepalived_Master ~]</code><code class="bash comments"># ip addr</code></div><div class="line number4 index3 alt1"><code class="bash plain">1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN </code></div><div class="line number5 index4 alt2"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash plain">link</code><code class="bash plain">/loopback</code> <code class="bash plain">00:00:00:00:00:00 brd 00:00:00:00:00:00</code></div><div class="line number6 index5 alt1"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash plain">inet 127.0.0.1</code><code class="bash plain">/8</code> <code class="bash plain">scope host lo</code></div><div class="line number7 index6 alt2"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash plain">inet6 ::1</code><code class="bash plain">/128</code> <code class="bash plain">scope host </code></div><div class="line number8 index7 alt1"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash plain">valid_lft forever preferred_lft forever</code></div><div class="line number9 index8 alt2"><code class="bash plain">2: eth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc pfifo_fast state UP qlen 1000</code></div><div class="line number10 index9 alt1"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash plain">link</code><code class="bash plain">/ether</code> <code class="bash plain">52:54:00:68:</code><code class="bash functions">dc</code><code class="bash plain">:b6 brd ff:ff:ff:ff:ff:ff</code></div><div class="line number11 index10 alt2"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash plain">inet 182.48.115.237</code><code class="bash plain">/27</code> <code class="bash plain">brd 182.48.115.255 scope global eth0</code></div><div class="line number12 index11 alt1"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash plain">inet 182.48.115.239</code><code class="bash plain">/32</code> <code class="bash plain">scope global eth0</code></div><div class="line number13 index12 alt2"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash plain">inet6 fe80::5054:ff:fe68:dcb6</code><code class="bash plain">/64</code> <code class="bash plain">scope link </code></div><div class="line number14 index13 alt1"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash plain">valid_lft forever preferred_lft forever</code></div><div class="line number15 index14 alt2">&nbsp;</div><div class="line number16 index15 alt1"><code class="bash plain">[root@Haproxy_Keepalived_Backup ~]</code><code class="bash comments"># ip addr</code></div><div class="line number17 index16 alt2"><code class="bash plain">1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN </code></div><div class="line number18 index17 alt1"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash plain">link</code><code class="bash plain">/loopback</code> <code class="bash plain">00:00:00:00:00:00 brd 00:00:00:00:00:00</code></div><div class="line number19 index18 alt2"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash plain">inet 127.0.0.1</code><code class="bash plain">/8</code> <code class="bash plain">scope host lo</code></div><div class="line number20 index19 alt1"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash plain">inet6 ::1</code><code class="bash plain">/128</code> <code class="bash plain">scope host </code></div><div class="line number21 index20 alt2"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash plain">valid_lft forever preferred_lft forever</code></div><div class="line number22 index21 alt1"><code class="bash plain">2: eth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc pfifo_fast state UP qlen 1000</code></div><div class="line number23 index22 alt2"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash plain">link</code><code class="bash plain">/ether</code> <code class="bash plain">52:54:00:7c:b8:f0 brd ff:ff:ff:ff:ff:ff</code></div><div class="line number24 index23 alt1"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash plain">inet 182.48.115.236</code><code class="bash plain">/27</code> <code class="bash plain">brd 182.48.115.255 scope global eth0</code></div><div class="line number25 index24 alt2"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash plain">inet 182.48.115.235</code><code class="bash plain">/32</code> <code class="bash plain">scope global eth0</code></div><div class="line number26 index25 alt1"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash plain">inet6 fe80::5054:ff:fe7c:b8f0</code><code class="bash plain">/64</code> <code class="bash plain">scope link </code></div><div class="line number27 index26 alt2"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash plain">valid_lft forever preferred_lft forever</code></div><div class="line number28 index27 alt1">&nbsp;</div><div class="line number29 index28 alt2">&nbsp;</div><div class="line number30 index29 alt1"><code class="bash plain">1）先关闭 Haproxy_Keepalived_Master的keepalived服务。查看</code><code class="bash plain">/var/log/message</code><code class="bash plain">日志，可以发现VIP资源已经转移走了</code></div><div class="line number31 index30 alt2"><code class="bash plain">[root@Haproxy_Keepalived_Master ~]</code><code class="bash comments"># /etc/init.d/keepalived stop</code></div><div class="line number32 index31 alt1"><code class="bash plain">Stopping keepalived:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; [&nbsp; OK&nbsp; ]</code></div><div class="line number33 index32 alt2">&nbsp;</div><div class="line number34 index33 alt1"><code class="bash plain">[root@Haproxy_Keepalived_Master ~]</code><code class="bash comments"># tail -f /var/log/messages</code></div><div class="line number35 index34 alt2"><code class="bash plain">May&nbsp; 5 16:16:45 Haproxy_Keepalived_Master Keepalived_vrrp[29820]: VRRP_Instance(VI_1) sent 0 priority</code></div><div class="line number36 index35 alt1"><code class="bash plain">May&nbsp; 5 16:16:45 Haproxy_Keepalived_Master Keepalived_vrrp[29820]: VRRP_Instance(VI_1) removing protocol VIPs.</code></div><div class="line number37 index36 alt2">&nbsp;</div><div class="line number38 index37 alt1"><code class="bash plain">[root@Haproxy_Keepalived_Master ~]</code><code class="bash comments"># ip addr</code></div><div class="line number39 index38 alt2"><code class="bash plain">1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN </code></div><div class="line number40 index39 alt1"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash plain">link</code><code class="bash plain">/loopback</code> <code class="bash plain">00:00:00:00:00:00 brd 00:00:00:00:00:00</code></div><div class="line number41 index40 alt2"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash plain">inet 127.0.0.1</code><code class="bash plain">/8</code> <code class="bash plain">scope host lo</code></div><div class="line number42 index41 alt1"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash plain">inet6 ::1</code><code class="bash plain">/128</code> <code class="bash plain">scope host </code></div><div class="line number43 index42 alt2"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash plain">valid_lft forever preferred_lft forever</code></div><div class="line number44 index43 alt1"><code class="bash plain">2: eth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc pfifo_fast state UP qlen 1000</code></div><div class="line number45 index44 alt2"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash plain">link</code><code class="bash plain">/ether</code> <code class="bash plain">52:54:00:68:</code><code class="bash functions">dc</code><code class="bash plain">:b6 brd ff:ff:ff:ff:ff:ff</code></div><div class="line number46 index45 alt1"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash plain">inet 182.48.115.237</code><code class="bash plain">/27</code> <code class="bash plain">brd 182.48.115.255 scope global eth0</code></div><div class="line number47 index46 alt2"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash plain">inet6 fe80::5054:ff:fe68:dcb6</code><code class="bash plain">/64</code> <code class="bash plain">scope link </code></div><div class="line number48 index47 alt1"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash plain">valid_lft forever preferred_lft forever</code></div><div class="line number49 index48 alt2">&nbsp;</div><div class="line number50 index49 alt1"><code class="bash plain">接着查看Haproxy_Keepalived_Backup的</code><code class="bash plain">/var/log/messages</code><code class="bash plain">日志，发现已经将Haproxy_Keepalived_Master的VIP接管过来了</code></div><div class="line number51 index50 alt2"><code class="bash plain">[root@Haproxy_Keepalived_Backup ~]</code><code class="bash comments"># tail -f /var/log/messages</code></div><div class="line number52 index51 alt1"><code class="bash plain">.......</code></div><div class="line number53 index52 alt2"><code class="bash plain">May&nbsp; 5 16:16:45 locahost Keepalived_vrrp[23381]: VRRP_Instance(VI_1) Transition to MASTER STATE</code></div><div class="line number54 index53 alt1"><code class="bash plain">May&nbsp; 5 16:16:46 locahost Keepalived_vrrp[23381]: VRRP_Instance(VI_1) Entering MASTER STATE</code></div><div class="line number55 index54 alt2"><code class="bash plain">May&nbsp; 5 16:16:46 locahost Keepalived_vrrp[23381]: VRRP_Instance(VI_1) setting protocol VIPs.</code></div><div class="line number56 index55 alt1"><code class="bash plain">May&nbsp; 5 16:16:46 locahost Keepalived_vrrp[23381]: Sending gratuitous ARP on eth0 </code><code class="bash keyword">for</code> <code class="bash plain">182.48.115.239</code></div><div class="line number57 index56 alt2"><code class="bash plain">May&nbsp; 5 16:16:46 locahost Keepalived_vrrp[23381]: VRRP_Instance(VI_1) Sending</code><code class="bash plain">/queueing</code> <code class="bash plain">gratuitous ARPs on eth0 </code><code class="bash keyword">for</code> <code class="bash plain">182.48.115.239</code></div><div class="line number58 index57 alt1"><code class="bash plain">May&nbsp; 5 16:16:46 locahost Keepalived_vrrp[23381]: Sending gratuitous ARP on eth0 </code><code class="bash keyword">for</code> <code class="bash plain">182.48.115.239</code></div><div class="line number59 index58 alt2"><code class="bash plain">May&nbsp; 5 16:16:46 locahost Keepalived_vrrp[23381]: Sending gratuitous ARP on eth0 </code><code class="bash keyword">for</code> <code class="bash plain">182.48.115.239</code></div><div class="line number60 index59 alt1"><code class="bash plain">May&nbsp; 5 16:16:46 locahost Keepalived_vrrp[23381]: Sending gratuitous ARP on eth0 </code><code class="bash keyword">for</code> <code class="bash plain">182.48.115.239</code></div><div class="line number61 index60 alt2"><code class="bash plain">May&nbsp; 5 16:16:46 locahost Keepalived_vrrp[23381]: Sending gratuitous ARP on eth0 </code><code class="bash keyword">for</code> <code class="bash plain">182.48.115.239</code></div><div class="line number62 index61 alt1"><code class="bash plain">May&nbsp; 5 16:16:51 locahost Keepalived_vrrp[23381]: Sending gratuitous ARP on eth0 </code><code class="bash keyword">for</code> <code class="bash plain">182.48.115.239</code></div><div class="line number63 index62 alt2">&nbsp;</div><div class="line number64 index63 alt1"><code class="bash plain">[root@Haproxy_Keepalived_Backup ~]</code><code class="bash comments"># ip addr</code></div><div class="line number65 index64 alt2"><code class="bash plain">1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN </code></div><div class="line number66 index65 alt1"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash plain">link</code><code class="bash plain">/loopback</code> <code class="bash plain">00:00:00:00:00:00 brd 00:00:00:00:00:00</code></div><div class="line number67 index66 alt2"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash plain">inet 127.0.0.1</code><code class="bash plain">/8</code> <code class="bash plain">scope host lo</code></div><div class="line number68 index67 alt1"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash plain">inet6 ::1</code><code class="bash plain">/128</code> <code class="bash plain">scope host </code></div><div class="line number69 index68 alt2"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash plain">valid_lft forever preferred_lft forever</code></div><div class="line number70 index69 alt1"><code class="bash plain">2: eth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc pfifo_fast state UP qlen 1000</code></div><div class="line number71 index70 alt2"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash plain">link</code><code class="bash plain">/ether</code> <code class="bash plain">52:54:00:7c:b8:f0 brd ff:ff:ff:ff:ff:ff</code></div><div class="line number72 index71 alt1"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash plain">inet 182.48.115.236</code><code class="bash plain">/27</code> <code class="bash plain">brd 182.48.115.255 scope global eth0</code></div><div class="line number73 index72 alt2"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash plain">inet 182.48.115.235</code><code class="bash plain">/32</code> <code class="bash plain">scope global eth0</code></div><div class="line number74 index73 alt1"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash plain">inet 182.48.115.239</code><code class="bash plain">/32</code> <code class="bash plain">scope global eth0</code></div><div class="line number75 index74 alt2"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash plain">inet6 fe80::5054:ff:fe7c:b8f0</code><code class="bash plain">/64</code> <code class="bash plain">scope link </code></div><div class="line number76 index75 alt1"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash plain">valid_lft forever preferred_lft forever</code></div><div class="line number77 index76 alt2">&nbsp;</div><div class="line number78 index77 alt1"><code class="bash plain">在浏览器里访问这两个域名，发现访问正常，没有受到影响！</code></div><div class="line number79 index78 alt2">&nbsp;</div><div class="line number80 index79 alt1"><code class="bash plain">然后将Haproxy_Keepalived_Master的Keepalived服务启动，就会发现它的vip又会自动转移回来</code></div><div class="line number81 index80 alt2"><code class="bash plain">[root@Haproxy_Keepalived_Master ~]</code><code class="bash comments"># /etc/init.d/keepalived start</code></div><div class="line number82 index81 alt1"><code class="bash plain">Starting keepalived:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; [&nbsp; OK&nbsp; ]</code></div><div class="line number83 index82 alt2"><code class="bash plain">[root@Haproxy_Keepalived_Master ~]</code><code class="bash comments"># ip addr</code></div><div class="line number84 index83 alt1"><code class="bash plain">1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN </code></div><div class="line number85 index84 alt2"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash plain">link</code><code class="bash plain">/loopback</code> <code class="bash plain">00:00:00:00:00:00 brd 00:00:00:00:00:00</code></div><div class="line number86 index85 alt1"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash plain">inet 127.0.0.1</code><code class="bash plain">/8</code> <code class="bash plain">scope host lo</code></div><div class="line number87 index86 alt2"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash plain">inet6 ::1</code><code class="bash plain">/128</code> <code class="bash plain">scope host </code></div><div class="line number88 index87 alt1"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash plain">valid_lft forever preferred_lft forever</code></div><div class="line number89 index88 alt2"><code class="bash plain">2: eth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc pfifo_fast state UP qlen 1000</code></div><div class="line number90 index89 alt1"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash plain">link</code><code class="bash plain">/ether</code> <code class="bash plain">52:54:00:68:</code><code class="bash functions">dc</code><code class="bash plain">:b6 brd ff:ff:ff:ff:ff:ff</code></div><div class="line number91 index90 alt2"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash plain">inet 182.48.115.237</code><code class="bash plain">/27</code> <code class="bash plain">brd 182.48.115.255 scope global eth0</code></div><div class="line number92 index91 alt1"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash plain">inet 182.48.115.239</code><code class="bash plain">/32</code> <code class="bash plain">scope global eth0</code></div><div class="line number93 index92 alt2"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash plain">inet6 fe80::5054:ff:fe68:dcb6</code><code class="bash plain">/64</code> <code class="bash plain">scope link </code></div><div class="line number94 index93 alt1"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash plain">valid_lft forever preferred_lft forever</code></div><div class="line number95 index94 alt2">&nbsp;</div><div class="line number96 index95 alt1"><code class="bash plain">而此时Haproxy_Keepalived_Backup的只有自己的vip了</code></div><div class="line number97 index96 alt2"><code class="bash plain">[root@Haproxy_Keepalived_Backup ~]</code><code class="bash comments"># ip addr</code></div><div class="line number98 index97 alt1"><code class="bash plain">1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN </code></div><div class="line number99 index98 alt2"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash plain">link</code><code class="bash plain">/loopback</code> <code class="bash plain">00:00:00:00:00:00 brd 00:00:00:00:00:00</code></div><div class="line number100 index99 alt1"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash plain">inet 127.0.0.1</code><code class="bash plain">/8</code> <code class="bash plain">scope host lo</code></div><div class="line number101 index100 alt2"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash plain">inet6 ::1</code><code class="bash plain">/128</code> <code class="bash plain">scope host </code></div><div class="line number102 index101 alt1"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash plain">valid_lft forever preferred_lft forever</code></div><div class="line number103 index102 alt2"><code class="bash plain">2: eth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc pfifo_fast state UP qlen 1000</code></div><div class="line number104 index103 alt1"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash plain">link</code><code class="bash plain">/ether</code> <code class="bash plain">52:54:00:7c:b8:f0 brd ff:ff:ff:ff:ff:ff</code></div><div class="line number105 index104 alt2"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash plain">inet 182.48.115.236</code><code class="bash plain">/27</code> <code class="bash plain">brd 182.48.115.255 scope global eth0</code></div><div class="line number106 index105 alt1"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash plain">inet 182.48.115.235</code><code class="bash plain">/32</code> <code class="bash plain">scope global eth0</code></div><div class="line number107 index106 alt2"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash plain">inet6 fe80::5054:ff:fe7c:b8f0</code><code class="bash plain">/64</code> <code class="bash plain">scope link </code></div><div class="line number108 index107 alt1"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash plain">valid_lft forever preferred_lft forever</code></div><div class="line number109 index108 alt2">&nbsp;</div><div class="line number110 index109 alt1"><code class="bash plain">同理，关闭Haproxy_Keepalived_Backup的keepalived，它的vip也会转移到Haproxy_Keepalived_Master机器上，等它重新启动keepalived后，它的vip也会重新转移回来！</code></div><div class="line number111 index110 alt2">&nbsp;</div><div class="line number112 index111 alt1"><code class="bash plain">--------------------------------------------------------------------------------------------------------------</code></div><div class="line number113 index112 alt2">&nbsp;</div><div class="line number114 index113 alt1"><code class="bash plain">最后关闭Haproxy_Keepalived_Master的haproxy进程，发现haproxy进程关闭后，vip资源还在，说明还在提供服务。</code></div><div class="line number115 index114 alt2"><code class="bash plain">这是因为在keepalived.conf文件里配置了haproxy进程的监控脚本，当haproxy进程关闭后，会自动执行监控脚本，当发现haproxy进程不在后，最多2s就会启动，如若haproxy启动失败，才会强制关闭keeaplived服务，</code></div><div class="line number116 index115 alt1"><code class="bash plain">此时就会转移vip到另一台机器上。所以，一般在keepalived服务启动的情况下，haproxy服务不会关闭，即使关闭了，也会自动重启。</code></div></div></td></tr></tbody></table></div></div>
</div>
<p>---------------------------------------------------------------------------------------------------<br><span style="background-color: #ffff99;"><strong><span style="font-size: 18px;">二、Haproxy+Keepalived主从模式的高可用环境</span></strong></span></p>
<div class="cnblogs_Highlighter sh-gutter">
<div><div id="highlighter_453511" class="syntaxhighlighter  bash"><div class="toolbar"><span><a href="#" class="toolbar_item command_help help">?</a></span></div><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div><div class="line number3 index2 alt2">3</div><div class="line number4 index3 alt1">4</div><div class="line number5 index4 alt2">5</div><div class="line number6 index5 alt1">6</div><div class="line number7 index6 alt2">7</div><div class="line number8 index7 alt1">8</div><div class="line number9 index8 alt2">9</div><div class="line number10 index9 alt1">10</div><div class="line number11 index10 alt2">11</div><div class="line number12 index11 alt1">12</div><div class="line number13 index12 alt2">13</div><div class="line number14 index13 alt1">14</div><div class="line number15 index14 alt2">15</div><div class="line number16 index15 alt1">16</div><div class="line number17 index16 alt2">17</div><div class="line number18 index17 alt1">18</div><div class="line number19 index18 alt2">19</div><div class="line number20 index19 alt1">20</div><div class="line number21 index20 alt2">21</div><div class="line number22 index21 alt1">22</div><div class="line number23 index22 alt2">23</div><div class="line number24 index23 alt1">24</div><div class="line number25 index24 alt2">25</div><div class="line number26 index25 alt1">26</div><div class="line number27 index26 alt2">27</div><div class="line number28 index27 alt1">28</div><div class="line number29 index28 alt2">29</div><div class="line number30 index29 alt1">30</div><div class="line number31 index30 alt2">31</div><div class="line number32 index31 alt1">32</div><div class="line number33 index32 alt2">33</div><div class="line number34 index33 alt1">34</div><div class="line number35 index34 alt2">35</div><div class="line number36 index35 alt1">36</div><div class="line number37 index36 alt2">37</div><div class="line number38 index37 alt1">38</div><div class="line number39 index38 alt2">39</div><div class="line number40 index39 alt1">40</div><div class="line number41 index40 alt2">41</div><div class="line number42 index41 alt1">42</div><div class="line number43 index42 alt2">43</div><div class="line number44 index43 alt1">44</div><div class="line number45 index44 alt2">45</div><div class="line number46 index45 alt1">46</div><div class="line number47 index46 alt2">47</div><div class="line number48 index47 alt1">48</div><div class="line number49 index48 alt2">49</div><div class="line number50 index49 alt1">50</div><div class="line number51 index50 alt2">51</div><div class="line number52 index51 alt1">52</div><div class="line number53 index52 alt2">53</div><div class="line number54 index53 alt1">54</div><div class="line number55 index54 alt2">55</div><div class="line number56 index55 alt1">56</div><div class="line number57 index56 alt2">57</div><div class="line number58 index57 alt1">58</div><div class="line number59 index58 alt2">59</div><div class="line number60 index59 alt1">60</div><div class="line number61 index60 alt2">61</div><div class="line number62 index61 alt1">62</div><div class="line number63 index62 alt2">63</div><div class="line number64 index63 alt1">64</div><div class="line number65 index64 alt2">65</div><div class="line number66 index65 alt1">66</div><div class="line number67 index66 alt2">67</div><div class="line number68 index67 alt1">68</div><div class="line number69 index68 alt2">69</div><div class="line number70 index69 alt1">70</div><div class="line number71 index70 alt2">71</div><div class="line number72 index71 alt1">72</div><div class="line number73 index72 alt2">73</div><div class="line number74 index73 alt1">74</div><div class="line number75 index74 alt2">75</div><div class="line number76 index75 alt1">76</div><div class="line number77 index76 alt2">77</div><div class="line number78 index77 alt1">78</div><div class="line number79 index78 alt2">79</div><div class="line number80 index79 alt1">80</div><div class="line number81 index80 alt2">81</div><div class="line number82 index81 alt1">82</div><div class="line number83 index82 alt2">83</div><div class="line number84 index83 alt1">84</div><div class="line number85 index84 alt2">85</div><div class="line number86 index85 alt1">86</div><div class="line number87 index86 alt2">87</div><div class="line number88 index87 alt1">88</div><div class="line number89 index88 alt2">89</div><div class="line number90 index89 alt1">90</div><div class="line number91 index90 alt2">91</div><div class="line number92 index91 alt1">92</div><div class="line number93 index92 alt2">93</div><div class="line number94 index93 alt1">94</div><div class="line number95 index94 alt2">95</div><div class="line number96 index95 alt1">96</div><div class="line number97 index96 alt2">97</div><div class="line number98 index97 alt1">98</div><div class="line number99 index98 alt2">99</div><div class="line number100 index99 alt1">100</div><div class="line number101 index100 alt2">101</div><div class="line number102 index101 alt1">102</div><div class="line number103 index102 alt2">103</div><div class="line number104 index103 alt1">104</div><div class="line number105 index104 alt2">105</div><div class="line number106 index105 alt1">106</div><div class="line number107 index106 alt2">107</div><div class="line number108 index107 alt1">108</div><div class="line number109 index108 alt2">109</div><div class="line number110 index109 alt1">110</div><div class="line number111 index110 alt2">111</div><div class="line number112 index111 alt1">112</div><div class="line number113 index112 alt2">113</div><div class="line number114 index113 alt1">114</div><div class="line number115 index114 alt2">115</div><div class="line number116 index115 alt1">116</div><div class="line number117 index116 alt2">117</div><div class="line number118 index117 alt1">118</div><div class="line number119 index118 alt2">119</div><div class="line number120 index119 alt1">120</div><div class="line number121 index120 alt2">121</div><div class="line number122 index121 alt1">122</div><div class="line number123 index122 alt2">123</div><div class="line number124 index123 alt1">124</div><div class="line number125 index124 alt2">125</div><div class="line number126 index125 alt1">126</div><div class="line number127 index126 alt2">127</div><div class="line number128 index127 alt1">128</div><div class="line number129 index128 alt2">129</div><div class="line number130 index129 alt1">130</div><div class="line number131 index130 alt2">131</div><div class="line number132 index131 alt1">132</div><div class="line number133 index132 alt2">133</div><div class="line number134 index133 alt1">134</div><div class="line number135 index134 alt2">135</div><div class="line number136 index135 alt1">136</div><div class="line number137 index136 alt2">137</div><div class="line number138 index137 alt1">138</div><div class="line number139 index138 alt2">139</div><div class="line number140 index139 alt1">140</div><div class="line number141 index140 alt2">141</div><div class="line number142 index141 alt1">142</div><div class="line number143 index142 alt2">143</div><div class="line number144 index143 alt1">144</div><div class="line number145 index144 alt2">145</div><div class="line number146 index145 alt1">146</div><div class="line number147 index146 alt2">147</div><div class="line number148 index147 alt1">148</div><div class="line number149 index148 alt2">149</div><div class="line number150 index149 alt1">150</div><div class="line number151 index150 alt2">151</div><div class="line number152 index151 alt1">152</div><div class="line number153 index152 alt2">153</div><div class="line number154 index153 alt1">154</div><div class="line number155 index154 alt2">155</div><div class="line number156 index155 alt1">156</div><div class="line number157 index156 alt2">157</div><div class="line number158 index157 alt1">158</div><div class="line number159 index158 alt2">159</div><div class="line number160 index159 alt1">160</div><div class="line number161 index160 alt2">161</div><div class="line number162 index161 alt1">162</div><div class="line number163 index162 alt2">163</div><div class="line number164 index163 alt1">164</div><div class="line number165 index164 alt2">165</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="bash plain">主从环境相比于主主环境，区别只在于keepalived.conf的配置不同，其他的配置都和主主模式下的一样，并且主从环境下只有一个VIP（默认在Master端配置）</code></div><div class="line number2 index1 alt1"><code class="bash plain">比如：VIP为182.148.15.239</code></div><div class="line number3 index2 alt2"><code class="bash spaces">&nbsp;</code>&nbsp;</div><div class="line number4 index3 alt1"><code class="bash plain">1）Haproxy_Keepalived_Master服务器上的Keepalived配置如下：</code></div><div class="line number5 index4 alt2"><code class="bash plain">[root@Haproxy_Keepalived_Master ~]</code><code class="bash comments"># cat /etc/keepalived/keepalived.conf</code></div><div class="line number6 index5 alt1"><code class="bash plain">! Configuration File </code><code class="bash keyword">for</code> <code class="bash plain">keepalived</code></div><div class="line number7 index6 alt2"><code class="bash plain">global_defs {</code></div><div class="line number8 index7 alt1"><code class="bash spaces">&nbsp;&nbsp;</code><code class="bash plain">notification_email {</code></div><div class="line number9 index8 alt2"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash plain">root@localhost</code></div><div class="line number10 index9 alt1"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash plain">}</code></div><div class="line number11 index10 alt2"><code class="bash spaces">&nbsp;</code>&nbsp;</div><div class="line number12 index11 alt1"><code class="bash plain">notification_email_from keepalived@localhost</code></div><div class="line number13 index12 alt2"><code class="bash plain">smtp_server 127.0.0.1</code></div><div class="line number14 index13 alt1"><code class="bash plain">smtp_connect_timeout 30</code></div><div class="line number15 index14 alt2"><code class="bash plain">router_id HAproxy237</code></div><div class="line number16 index15 alt1"><code class="bash plain">}</code></div><div class="line number17 index16 alt2"><code class="bash spaces">&nbsp;</code>&nbsp;</div><div class="line number18 index17 alt1"><code class="bash plain">vrrp_script chk_haproxy {&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </code></div><div class="line number19 index18 alt2"><code class="bash spaces">&nbsp;&nbsp;</code><code class="bash plain">script </code><code class="bash string">"/etc/keepalived/check_haproxy.sh"</code></div><div class="line number20 index19 alt1"><code class="bash spaces">&nbsp;&nbsp;</code><code class="bash plain">interval 2</code></div><div class="line number21 index20 alt2"><code class="bash spaces">&nbsp;&nbsp;</code><code class="bash plain">weight 2</code></div><div class="line number22 index21 alt1"><code class="bash plain">}</code></div><div class="line number23 index22 alt2"><code class="bash spaces">&nbsp;</code>&nbsp;</div><div class="line number24 index23 alt1"><code class="bash plain">vrrp_instance VI_1 {</code></div><div class="line number25 index24 alt2"><code class="bash spaces">&nbsp;&nbsp;</code><code class="bash plain">state MASTER</code></div><div class="line number26 index25 alt1"><code class="bash spaces">&nbsp;&nbsp;</code><code class="bash plain">interface eth0</code></div><div class="line number27 index26 alt2"><code class="bash spaces">&nbsp;&nbsp;</code><code class="bash plain">virtual_router_id 51</code></div><div class="line number28 index27 alt1"><code class="bash spaces">&nbsp;&nbsp;</code><code class="bash plain">priority 100</code></div><div class="line number29 index28 alt2"><code class="bash spaces">&nbsp;&nbsp;</code><code class="bash plain">advert_int 1</code></div><div class="line number30 index29 alt1"><code class="bash spaces">&nbsp;&nbsp;</code><code class="bash plain">authentication {</code></div><div class="line number31 index30 alt2"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash plain">auth_type PASS</code></div><div class="line number32 index31 alt1"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash plain">auth_pass 1111</code></div><div class="line number33 index32 alt2"><code class="bash plain">}</code></div><div class="line number34 index33 alt1"><code class="bash spaces">&nbsp;&nbsp;</code><code class="bash plain">track_script {</code></div><div class="line number35 index34 alt2"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash plain">chk_haproxy</code></div><div class="line number36 index35 alt1"><code class="bash plain">}</code></div><div class="line number37 index36 alt2"><code class="bash plain">virtual_ipaddress {</code></div><div class="line number38 index37 alt1"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash plain">182.148.15.239</code></div><div class="line number39 index38 alt2"><code class="bash plain">}</code></div><div class="line number40 index39 alt1"><code class="bash plain">notify_master </code><code class="bash string">"/etc/keepalived/clean_arp.sh 182.148.15.239"</code></div><div class="line number41 index40 alt2"><code class="bash plain">}</code></div><div class="line number42 index41 alt1"><code class="bash spaces">&nbsp;</code>&nbsp;</div><div class="line number43 index42 alt2"><code class="bash plain">2）Haproxy_Keepalived_Backup服务器上的Keepalived配置如下：</code></div><div class="line number44 index43 alt1"><code class="bash plain">[root@Haproxy_Keepalived_Backup ~]</code><code class="bash comments"># cat /etc/keepalived/keepalived.conf</code></div><div class="line number45 index44 alt2"><code class="bash plain">! Configuration File </code><code class="bash keyword">for</code> <code class="bash plain">keepalived</code></div><div class="line number46 index45 alt1"><code class="bash plain">global_defs {</code></div><div class="line number47 index46 alt2"><code class="bash spaces">&nbsp;&nbsp;</code><code class="bash plain">notification_email {</code></div><div class="line number48 index47 alt1"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash plain">root@localhost</code></div><div class="line number49 index48 alt2"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash plain">}</code></div><div class="line number50 index49 alt1"><code class="bash spaces">&nbsp;</code>&nbsp;</div><div class="line number51 index50 alt2"><code class="bash plain">notification_email_from keepalived@localhost</code></div><div class="line number52 index51 alt1"><code class="bash plain">smtp_server 127.0.0.1</code></div><div class="line number53 index52 alt2"><code class="bash plain">smtp_connect_timeout 30</code></div><div class="line number54 index53 alt1"><code class="bash plain">router_id HAproxy236</code></div><div class="line number55 index54 alt2"><code class="bash plain">}</code></div><div class="line number56 index55 alt1"><code class="bash spaces">&nbsp;</code>&nbsp;</div><div class="line number57 index56 alt2"><code class="bash plain">vrrp_script chk_haproxy {&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </code></div><div class="line number58 index57 alt1"><code class="bash spaces">&nbsp;&nbsp;</code><code class="bash plain">script </code><code class="bash string">"/etc/keepalived/check_haproxy.sh"</code></div><div class="line number59 index58 alt2"><code class="bash spaces">&nbsp;&nbsp;</code><code class="bash plain">interval 2</code></div><div class="line number60 index59 alt1"><code class="bash spaces">&nbsp;&nbsp;</code><code class="bash plain">weight 2</code></div><div class="line number61 index60 alt2"><code class="bash plain">}</code></div><div class="line number62 index61 alt1"><code class="bash spaces">&nbsp;</code>&nbsp;</div><div class="line number63 index62 alt2"><code class="bash plain">vrrp_instance VI_1 {</code></div><div class="line number64 index63 alt1"><code class="bash spaces">&nbsp;&nbsp;</code><code class="bash plain">state BACKUP</code></div><div class="line number65 index64 alt2"><code class="bash spaces">&nbsp;&nbsp;</code><code class="bash plain">interface eth0</code></div><div class="line number66 index65 alt1"><code class="bash spaces">&nbsp;&nbsp;</code><code class="bash plain">virtual_router_id 51</code></div><div class="line number67 index66 alt2"><code class="bash spaces">&nbsp;&nbsp;</code><code class="bash plain">priority 99</code></div><div class="line number68 index67 alt1"><code class="bash spaces">&nbsp;&nbsp;</code><code class="bash plain">advert_int 1</code></div><div class="line number69 index68 alt2"><code class="bash spaces">&nbsp;&nbsp;</code><code class="bash plain">authentication {</code></div><div class="line number70 index69 alt1"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash plain">auth_type PASS</code></div><div class="line number71 index70 alt2"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash plain">auth_pass 1111</code></div><div class="line number72 index71 alt1"><code class="bash plain">}</code></div><div class="line number73 index72 alt2"><code class="bash spaces">&nbsp;&nbsp;</code><code class="bash plain">track_script {</code></div><div class="line number74 index73 alt1"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash plain">chk_haproxy</code></div><div class="line number75 index74 alt2"><code class="bash plain">}</code></div><div class="line number76 index75 alt1"><code class="bash plain">virtual_ipaddress {</code></div><div class="line number77 index76 alt2"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash plain">182.148.15.239</code></div><div class="line number78 index77 alt1"><code class="bash plain">}</code></div><div class="line number79 index78 alt2"><code class="bash plain">notify_master </code><code class="bash string">"/etc/keepalived/clean_arp.sh 182.148.15.239"</code></div><div class="line number80 index79 alt1"><code class="bash plain">}</code></div><div class="line number81 index80 alt2"><code class="bash spaces">&nbsp;</code>&nbsp;</div><div class="line number82 index81 alt1"><code class="bash spaces">&nbsp;</code>&nbsp;</div><div class="line number83 index82 alt2"><code class="bash plain">3）分别重启两台机器的keepalived服务，再次查看vip，发现vip默认是在Haproxy_Keepalived_Master下</code></div><div class="line number84 index83 alt1"><code class="bash plain">[root@Haproxy_Keepalived_Master ~]</code><code class="bash comments"># /etc/init.d/keepalived restart</code></div><div class="line number85 index84 alt2"><code class="bash plain">Stopping keepalived:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; [&nbsp; OK&nbsp; ]</code></div><div class="line number86 index85 alt1"><code class="bash plain">Starting keepalived:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; [&nbsp; OK&nbsp; ]</code></div><div class="line number87 index86 alt2"><code class="bash plain">[root@Haproxy_Keepalived_Master ~]</code><code class="bash comments"># ip addr</code></div><div class="line number88 index87 alt1"><code class="bash plain">1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN</code></div><div class="line number89 index88 alt2"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash plain">link</code><code class="bash plain">/loopback</code> <code class="bash plain">00:00:00:00:00:00 brd 00:00:00:00:00:00</code></div><div class="line number90 index89 alt1"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash plain">inet 127.0.0.1</code><code class="bash plain">/8</code> <code class="bash plain">scope host lo</code></div><div class="line number91 index90 alt2"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash plain">inet6 ::1</code><code class="bash plain">/128</code> <code class="bash plain">scope host</code></div><div class="line number92 index91 alt1"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash plain">valid_lft forever preferred_lft forever</code></div><div class="line number93 index92 alt2"><code class="bash plain">2: eth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc pfifo_fast state UP qlen 1000</code></div><div class="line number94 index93 alt1"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash plain">link</code><code class="bash plain">/ether</code> <code class="bash plain">52:54:00:68:</code><code class="bash functions">dc</code><code class="bash plain">:b6 brd ff:ff:ff:ff:ff:ff</code></div><div class="line number95 index94 alt2"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash plain">inet 182.148.15.237</code><code class="bash plain">/27</code> <code class="bash plain">brd 182.148.15.255 scope global eth0</code></div><div class="line number96 index95 alt1"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash plain">inet 182.148.15.239</code><code class="bash plain">/32</code> <code class="bash plain">scope global eth0</code></div><div class="line number97 index96 alt2"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash plain">inet6 fe80::5054:ff:fe68:dcb6</code><code class="bash plain">/64</code> <code class="bash plain">scope link</code></div><div class="line number98 index97 alt1"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash plain">valid_lft forever preferred_lft forever</code></div><div class="line number99 index98 alt2"><code class="bash spaces">&nbsp;</code>&nbsp;</div><div class="line number100 index99 alt1"><code class="bash plain">[root@Haproxy_Keepalived_Backup ~]</code><code class="bash comments"># /etc/init.d/keepalived restart</code></div><div class="line number101 index100 alt2"><code class="bash plain">Stopping keepalived:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; [&nbsp; OK&nbsp; ]</code></div><div class="line number102 index101 alt1"><code class="bash plain">Starting keepalived:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; [&nbsp; OK&nbsp; ]</code></div><div class="line number103 index102 alt2"><code class="bash plain">[root@Haproxy_Keepalived_Backup ~]</code><code class="bash comments"># ip addr</code></div><div class="line number104 index103 alt1"><code class="bash plain">1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN</code></div><div class="line number105 index104 alt2"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash plain">link</code><code class="bash plain">/loopback</code> <code class="bash plain">00:00:00:00:00:00 brd 00:00:00:00:00:00</code></div><div class="line number106 index105 alt1"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash plain">inet 127.0.0.1</code><code class="bash plain">/8</code> <code class="bash plain">scope host lo</code></div><div class="line number107 index106 alt2"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash plain">inet6 ::1</code><code class="bash plain">/128</code> <code class="bash plain">scope host</code></div><div class="line number108 index107 alt1"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash plain">valid_lft forever preferred_lft forever</code></div><div class="line number109 index108 alt2"><code class="bash plain">2: eth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc pfifo_fast state UP qlen 1000</code></div><div class="line number110 index109 alt1"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash plain">link</code><code class="bash plain">/ether</code> <code class="bash plain">52:54:00:7c:b8:f0 brd ff:ff:ff:ff:ff:ff</code></div><div class="line number111 index110 alt2"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash plain">inet 182.148.15.236</code><code class="bash plain">/27</code> <code class="bash plain">brd 182.148.15.255 scope global eth0</code></div><div class="line number112 index111 alt1"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash plain">inet6 fe80::5054:ff:fe7c:b8f0</code><code class="bash plain">/64</code> <code class="bash plain">scope link</code></div><div class="line number113 index112 alt2"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash plain">valid_lft forever preferred_lft forever</code></div><div class="line number114 index113 alt1"><code class="bash spaces">&nbsp;</code>&nbsp;</div><div class="line number115 index114 alt2"><code class="bash plain">4）测试</code></div><div class="line number116 index115 alt1"><code class="bash plain">关闭Haproxy_Keepalived_Master的keepalived进程，发现VIP资源已经漂移到Haproxy_Keepalived_Backup上了</code></div><div class="line number117 index116 alt2"><code class="bash plain">[root@Haproxy_Keepalived_Master ~]</code><code class="bash comments"># /etc/init.d/keepalived stop</code></div><div class="line number118 index117 alt1"><code class="bash plain">Stopping keepalived:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; [&nbsp; OK&nbsp; ]</code></div><div class="line number119 index118 alt2"><code class="bash plain">[root@Haproxy_Keepalived_Master ~]</code><code class="bash comments"># ip addr</code></div><div class="line number120 index119 alt1"><code class="bash plain">1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN</code></div><div class="line number121 index120 alt2"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash plain">link</code><code class="bash plain">/loopback</code> <code class="bash plain">00:00:00:00:00:00 brd 00:00:00:00:00:00</code></div><div class="line number122 index121 alt1"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash plain">inet 127.0.0.1</code><code class="bash plain">/8</code> <code class="bash plain">scope host lo</code></div><div class="line number123 index122 alt2"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash plain">inet6 ::1</code><code class="bash plain">/128</code> <code class="bash plain">scope host</code></div><div class="line number124 index123 alt1"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash plain">valid_lft forever preferred_lft forever</code></div><div class="line number125 index124 alt2"><code class="bash plain">2: eth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc pfifo_fast state UP qlen 1000</code></div><div class="line number126 index125 alt1"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash plain">link</code><code class="bash plain">/ether</code> <code class="bash plain">52:54:00:68:</code><code class="bash functions">dc</code><code class="bash plain">:b6 brd ff:ff:ff:ff:ff:ff</code></div><div class="line number127 index126 alt2"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash plain">inet 182.148.15.237</code><code class="bash plain">/27</code> <code class="bash plain">brd 182.148.15.255 scope global eth0</code></div><div class="line number128 index127 alt1"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash plain">inet6 fe80::5054:ff:fe68:dcb6</code><code class="bash plain">/64</code> <code class="bash plain">scope link</code></div><div class="line number129 index128 alt2"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash plain">valid_lft forever preferred_lft forever</code></div><div class="line number130 index129 alt1"><code class="bash spaces">&nbsp;</code>&nbsp;</div><div class="line number131 index130 alt2"><code class="bash plain">查看Haproxy_Keepalived_Backup机器，发现VIP已经转移过来</code></div><div class="line number132 index131 alt1"><code class="bash plain">[root@Haproxy_Keepalived_Backup ~]</code><code class="bash comments"># ip addr</code></div><div class="line number133 index132 alt2"><code class="bash plain">1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN</code></div><div class="line number134 index133 alt1"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash plain">link</code><code class="bash plain">/loopback</code> <code class="bash plain">00:00:00:00:00:00 brd 00:00:00:00:00:00</code></div><div class="line number135 index134 alt2"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash plain">inet 127.0.0.1</code><code class="bash plain">/8</code> <code class="bash plain">scope host lo</code></div><div class="line number136 index135 alt1"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash plain">inet6 ::1</code><code class="bash plain">/128</code> <code class="bash plain">scope host</code></div><div class="line number137 index136 alt2"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash plain">valid_lft forever preferred_lft forever</code></div><div class="line number138 index137 alt1"><code class="bash plain">2: eth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc pfifo_fast state UP qlen 1000</code></div><div class="line number139 index138 alt2"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash plain">link</code><code class="bash plain">/ether</code> <code class="bash plain">52:54:00:7c:b8:f0 brd ff:ff:ff:ff:ff:ff</code></div><div class="line number140 index139 alt1"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash plain">inet 182.148.15.236</code><code class="bash plain">/27</code> <code class="bash plain">brd 182.148.15.255 scope global eth0</code></div><div class="line number141 index140 alt2"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash plain">inet 182.148.15.239</code><code class="bash plain">/32</code> <code class="bash plain">scope global eth0</code></div><div class="line number142 index141 alt1"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash plain">inet6 fe80::5054:ff:fe7c:b8f0</code><code class="bash plain">/64</code> <code class="bash plain">scope link</code></div><div class="line number143 index142 alt2"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash plain">valid_lft forever preferred_lft forever</code></div><div class="line number144 index143 alt1"><code class="bash spaces">&nbsp;</code>&nbsp;</div><div class="line number145 index144 alt2"><code class="bash plain">然后再次启动Haproxy_Keepalived_Master的keepalived进程，发现VIP资源又转移回来。</code></div><div class="line number146 index145 alt1"><code class="bash plain">[root@Haproxy_Keepalived_Master ~]</code><code class="bash comments"># /etc/init.d/keepalived start</code></div><div class="line number147 index146 alt2"><code class="bash plain">Starting keepalived:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; [&nbsp; OK&nbsp; ]</code></div><div class="line number148 index147 alt1"><code class="bash plain">[root@Haproxy_Keepalived_Master ~]</code><code class="bash comments"># ip addr</code></div><div class="line number149 index148 alt2"><code class="bash plain">1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN</code></div><div class="line number150 index149 alt1"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash plain">link</code><code class="bash plain">/loopback</code> <code class="bash plain">00:00:00:00:00:00 brd 00:00:00:00:00:00</code></div><div class="line number151 index150 alt2"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash plain">inet 127.0.0.1</code><code class="bash plain">/8</code> <code class="bash plain">scope host lo</code></div><div class="line number152 index151 alt1"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash plain">inet6 ::1</code><code class="bash plain">/128</code> <code class="bash plain">scope host</code></div><div class="line number153 index152 alt2"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash plain">valid_lft forever preferred_lft forever</code></div><div class="line number154 index153 alt1"><code class="bash plain">2: eth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc pfifo_fast state UP qlen 1000</code></div><div class="line number155 index154 alt2"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash plain">link</code><code class="bash plain">/ether</code> <code class="bash plain">52:54:00:68:</code><code class="bash functions">dc</code><code class="bash plain">:b6 brd ff:ff:ff:ff:ff:ff</code></div><div class="line number156 index155 alt1"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash plain">inet 182.148.15.237</code><code class="bash plain">/27</code> <code class="bash plain">brd 182.148.15.255 scope global eth0</code></div><div class="line number157 index156 alt2"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash plain">inet 182.148.15.239</code><code class="bash plain">/32</code> <code class="bash plain">scope global eth0</code></div><div class="line number158 index157 alt1"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash plain">inet6 fe80::5054:ff:fe68:dcb6</code><code class="bash plain">/64</code> <code class="bash plain">scope link</code></div><div class="line number159 index158 alt2"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash plain">valid_lft forever preferred_lft forever</code></div><div class="line number160 index159 alt1"><code class="bash spaces">&nbsp;</code>&nbsp;</div><div class="line number161 index160 alt2"><code class="bash plain">再以上测试过程中，对于两个测试域名的访问时不受影响的。</code></div><div class="line number162 index161 alt1"><code class="bash spaces">&nbsp;</code>&nbsp;</div><div class="line number163 index162 alt2"><code class="bash plain">--------------------------------------------------------------------------------------</code></div><div class="line number164 index163 alt1"><code class="bash plain">关闭Haproxy进程，由于已经在keepalived.conf文件里配置了chk_haproxy的监控脚本，即：</code></div><div class="line number165 index164 alt2"><code class="bash plain">Haproxy进程关闭后，会自动执行这个监控脚本区启动haproxy，如果启动失败，就会强制关闭keepalived进程，从而实现VIP资源的转移。</code></div></div></td></tr></tbody></table></div></div>
</div></div><div id="MySignature" style="display: block;">***************当你发现自己的才华撑不起野心时，就请安静下来学习吧***************</div>
<div class="clear"></div>
<div id="blog_post_info_block">
<div id="BlogPostCategory">分类: <a href="https://www.cnblogs.com/kevingrace/category/899066.html" target="_blank">LB+HA</a>,<a href="https://www.cnblogs.com/kevingrace/category/924880.html" target="_blank">Haproxy</a></div>
<div id="EntryTag"></div>
<div id="blog_post_info"><div id="green_channel">
        <a href="javascript:void(0);" id="green_channel_digg" onclick="DiggIt(5892169,cb_blogId,1);green_channel_success(this,'谢谢推荐！');">好文要顶</a>
            <a id="green_channel_follow" onclick="follow('2423edd6-4be4-e511-9fc1-ac853d9f53cc');" href="javascript:void(0);">关注我</a>
    <a id="green_channel_favorite" onclick="AddToWz(cb_entryId);return false;" href="javascript:void(0);">收藏该文</a>
    <a id="green_channel_weibo" href="javascript:void(0);" title="分享至新浪微博" onclick="ShareToTsina()"><img src="//common.cnblogs.com/images/icon_weibo_24.png" alt=""></a>
    <a id="green_channel_wechat" href="javascript:void(0);" title="分享至微信" onclick="shareOnWechat()"><img src="//common.cnblogs.com/images/wechat.png" alt=""></a>
</div>
<div id="author_profile">
    <div id="author_profile_info" class="author_profile_info">
            <a href="http://home.cnblogs.com/u/kevingrace/" target="_blank"><img src="//pic.cnblogs.com/face/907596/20161124180837.png" class="author_avatar" alt=""></a>
        <div id="author_profile_detail" class="author_profile_info">
            <a href="http://home.cnblogs.com/u/kevingrace/">散尽浮华</a><br>
            <a href="http://home.cnblogs.com/u/kevingrace/followees">关注 - 23</a><br>
            <a href="http://home.cnblogs.com/u/kevingrace/followers">粉丝 - 1273</a>
        </div>
    </div>
    <div class="clear"></div>
    <div id="author_profile_honor"></div>
    <div id="author_profile_follow">
                <a href="javascript:void(0);" onclick="follow('2423edd6-4be4-e511-9fc1-ac853d9f53cc');return false;">+加关注</a>
    </div>
</div>
<div id="div_digg">
    <div class="diggit" onclick="votePost(5892169,'Digg')">
        <span class="diggnum" id="digg_count">1</span>
    </div>
    <div class="buryit" onclick="votePost(5892169,'Bury')">
        <span class="burynum" id="bury_count">0</span>
    </div>
    <div class="clear"></div>
    <div class="diggword" id="digg_tips">
    </div>
</div>
<script type="text/javascript">
    currentDiggType = 0;
</script></div>
<div class="clear"></div>
<div id="post_next_prev"><a href="https://www.cnblogs.com/kevingrace/p/5892165.html" class="p_n_p_prefix">« </a> 上一篇：<a href="https://www.cnblogs.com/kevingrace/p/5892165.html" title="发布于2016-09-21 12:07">haproxy反向代理环境部署（http和https代理）</a><br><a href="https://www.cnblogs.com/kevingrace/p/5893121.html" class="p_n_p_prefix">» </a> 下一篇：<a href="https://www.cnblogs.com/kevingrace/p/5893121.html" title="发布于2016-09-21 16:20">python报错问题解决：'ascii' codec can't encode character</a><br></div>
</div>


		</div>
		<div class="postDesc">posted @ <span id="post-date">2016-09-21 12:08</span> <a href="https://www.cnblogs.com/kevingrace/">散尽浮华</a> 阅读(<span id="post_view_count">4615</span>) 评论(<span id="post_comment_count">4</span>)  <a href="https://i.cnblogs.com/EditPosts.aspx?postid=5892169" rel="nofollow">编辑</a> <a href="#" onclick="AddToWz(5892169);return false;">收藏</a></div>
	</div>